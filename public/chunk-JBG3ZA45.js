import{a as fe}from"./chunk-4ZXAGEBE.js";import{b as pe,c as ue,d as ve}from"./chunk-MRMPQ2PL.js";import{a as se,b as de}from"./chunk-B7XUX2AB.js";import"./chunk-5RJIBXIL.js";import{a as F}from"./chunk-KGOR65YN.js";import{a as me}from"./chunk-B2MQD4SO.js";import{a as le}from"./chunk-SVF2QQ2X.js";import{a as ce}from"./chunk-QULINWIQ.js";import{b as Q,c as d,d as H,e as J,h as K,i as X,k as Y,l as Z,m as ee,n as te,o as ie,p as ne,q as oe,t as re,u as ae}from"./chunk-UQEQGUXM.js";import{A as j,B as E,C as W,J as z,f as R,i as G,j as V,k as q,p as B,v as L,w as U,z as $}from"./chunk-K4252JJD.js";import{Ba as N,C as M,Ib as o,Jb as y,Kb as D,La as c,Rb as b,Tb as x,Va as k,_a as u,ba as m,eb as f,ec as g,ia as C,ja as S,jb as v,mb as T,na as P,nb as A,ob as n,pb as i,qb as l,ub as w,wa as I,yb as h,zb as _}from"./chunk-QAVPLLNK.js";var Ie=(r,e)=>e.id,he=(r,e)=>e.code;function Ce(r,e){r&1&&(n(0,"small",12),o(1," cliente es requerido "),i())}function Se(r,e){r&1&&(n(0,"small",12),o(1," fecha inicio es requerida "),i())}function ge(r,e){r&1&&(n(0,"small",12),o(1," item es requerido "),i())}function be(r,e){r&1&&(n(0,"small",12),o(1," cantidad debe ser > 0 "),i())}function xe(r,e){r&1&&(n(0,"small",12),o(1," precio incorrecto "),i())}function Ee(r,e){if(r&1&&(n(0,"option",48),o(1),i()),r&2){let t=e.$implicit;f("value",t.id),c(),D(" ",`${t.code} - ${t.name}`," ")}}function Fe(r,e){r&1&&(n(0,"small",12),o(1," contabilidad es requerido "),i())}function ye(r,e){if(r&1&&(n(0,"option",48),o(1),i()),r&2){let t=e.$implicit;f("value",t.code),c(),y(t.label)}}function De(r,e){r&1&&(n(0,"small",12),o(1," impuesto es requerido "),i())}function Te(r,e){if(r&1){let t=w();n(0,"tr",40)(1,"td")(2,"custom-select",41),h("itemSelectedEmitter",function(s){let p=C(t).index,_e=_(2);return S(_e.onItemSelectedInRow(s,p))}),i(),u(3,ge,2,0,"small",12),i(),n(4,"td"),l(5,"textarea",42),i(),n(6,"td"),l(7,"input",43),u(8,be,2,0,"small",12),i(),n(9,"td"),l(10,"input",44),u(11,xe,2,0,"small",12),i(),n(12,"td"),l(13,"input",45),i(),n(14,"td")(15,"select",46)(16,"option",47),o(17,"--Seleccione--"),i(),T(18,Ee,2,2,"option",48,Ie),i(),u(20,Fe,2,0,"small",12),i(),n(21,"td")(22,"select",49),T(23,ye,2,2,"option",48,he),i(),u(25,De,2,0,"small",12),i(),n(26,"td")(27,"button",50),h("click",function(){let s=C(t).index,p=_(2);return S(p.removeInvoiceItem(s))}),l(28,"i",51),i()()()}if(r&2){let t=e.index,a=_(2);f("formGroupName",t)("id","row_"+t),c(3),v(a.validField("invoiceItems."+t+".itemId")?3:-1),c(5),v(a.validField("invoiceItems."+t+".quantity")?8:-1),c(3),v(a.validField("invoiceItems."+t+".price")?11:-1),c(7),A(a.accounts()),c(2),v(a.validField("invoiceItems."+t+".accountId")?20:-1),c(3),A(a.taxRates),c(2),v(a.validField("invoiceItems."+t+".taxRate")?25:-1)}}function Ae(r,e){r&1&&(n(0,"tr",29)(1,"td",52)(2,"small"),o(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),i()()())}function we(r,e){if(r&1){let t=w();n(0,"form",6)(1,"div",7)(2,"div",8)(3,"label",9),o(4," Cliente "),n(5,"span",10),o(6,"*"),i()(),l(7,"ng-select",11),u(8,Ce,2,0,"small",12),i(),n(9,"div",8)(10,"label",13),o(11," Fecha inicio "),n(12,"span",10),o(13,"*"),i()(),l(14,"input",14),u(15,Se,2,0,"small",12),i(),n(16,"div",8)(17,"label",15),o(18," Fecha expira "),n(19,"span",16),o(20,"opcional"),i()(),n(21,"quick-date-picker",17),h("dateChanged",function(s){C(t);let p=_();return S(p.onExpireDateChange(s))}),i()(),n(22,"div",8)(23,"label",15),o(24," Moneda "),n(25,"span",10),o(26,"*"),i()(),n(27,"select",18)(28,"option",19),o(29,"USD"),i()()(),n(30,"div",8)(31,"div",20)(32,"label",21),o(33," Referencia "),n(34,"span",16),o(35,"opcional"),i()(),l(36,"i",22),i(),l(37,"input",23),i()(),n(38,"table",24)(39,"thead")(40,"tr")(41,"th",25)(42,"label"),o(43,"Item"),i()(),n(44,"th",25)(45,"label"),o(46,"Descripci\xF3n"),i()(),n(47,"th",26)(48,"label"),o(49," Cantidad "),i()(),n(50,"th",26)(51,"label"),o(52,"Precio"),i()(),n(53,"th",26)(54,"label"),o(55,"Descuento (%)"),i()(),n(56,"th",26)(57,"label"),o(58,"Cuenta"),i()(),n(59,"th",26)(60,"label"),o(61,"Impuesto"),i()(),l(62,"th",26),i()(),n(63,"tbody",27),u(64,Te,29,7,"tr",28)(65,Ae,4,0,"tr",29),i()(),n(66,"button",30),h("click",function(){C(t);let s=_();return S(s.addInvoiceItem())}),l(67,"i",31),o(68," Agregar fila "),i(),n(69,"div",32)(70,"div",33)(71,"ul",34)(72,"li",35)(73,"span"),o(74,"Subtotal"),i(),n(75,"span"),o(76),b(77,"number"),i()(),n(78,"li",35)(79,"span"),o(80,"Descuento total"),i(),n(81,"span",12),o(82),b(83,"number"),i()(),n(84,"li",35)(85,"span"),o(86,"Impuesto total"),i(),n(87,"span"),o(88),b(89,"number"),i()(),l(90,"div",36),n(91,"li",37)(92,"span")(93,"span"),o(94,"Total"),i()(),n(95,"strong"),o(96),b(97,"number"),i()()()()(),n(98,"div",38)(99,"submit-button",39),h("btnWasClicked",function(s){C(t);let p=_();return S(p.onCustomSubmitBtnClicked(s))}),i()()()}if(r&2){let t=_();f("formGroup",t.editInvoiceForm()),c(7),f("items",t.clients())("searchable",!0),c(),v(t.validField("clientId")?8:-1),c(7),v(t.validField("initDate")?15:-1),c(49),f("ngForOf",t.invoiceItems.controls),c(),v(t.invoiceItems.value.length?-1:65),c(11),y(x(77,13,t.subtotal(),"1.2-2")),c(6),D(" - ",x(83,16,t.totalDiscount(),"1.2-2")," "),c(6),y(x(89,19,t.totalTax(),"1.2-2")),c(8),D(" ",x(97,22,t.totalAmount(),"1.2-2")," "),c(3),f("isFormSubmitting",t.isFormSubmitting())("buttonAction",t.formInvoiceService.editAction)}}var O=class r{platformId=m(N);fb=m(re);destroyRef=m(P);activatedRoute=m(B);authService=m(L);accountService=m(U);commonAdminService=m(me);invoiceService=m(z);clientService=m($);formErrorService=m(le);customToastService=m(ce);sellers=I([]);accounts=I([]);invoiceId=I(null);invoice=I(null);formInvoiceService=m(fe);isFormSubmitting=g(()=>this.formInvoiceService.isFormSubmitting());taxRates=W;clients=I([]);editInvoiceForm=I(null);subtotal=g(()=>this.formInvoiceService.subtotal());totalDiscount=g(()=>this.formInvoiceService.totalDiscount());totalTax=g(()=>this.formInvoiceService.totalTax());totalAmount=g(()=>this.formInvoiceService.totalAmount());get isBrowser(){return q(this.platformId)}get currentDate(){return E(new Date)}get dateInSevenDay(){let e=new Date,t=new Date(new Date().setDate(e.getDate()+7));return E(t)}constructor(){this.invoiceId.set(this.activatedRoute.snapshot.params.id)}ngOnInit(){this.fetchAllShortClients(),this.fetchAccounts(),this.fetchInvoiceById()}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(F(this.destroyRef)).subscribe(e=>{e&&e.accounts&&this.accounts.set(e.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(F(this.destroyRef)).subscribe(e=>{e&&this.clients.set(e)})}fetchInvoiceById(){this.invoiceService.fetchOne(this.invoiceId()).pipe(F(this.destroyRef)).subscribe(e=>{e&&e.id&&(this.invoice.set(e),this.fillOutInvoiceForm())})}fillOutInvoiceForm(){let e=this.invoice(),t=this.fb.array(e.invoiceItems.map(a=>{let s={itemId:a.item.id,description:a.description??"",quantity:a.quantity,price:a.price,discount:a.discount??0,accountId:a.account?.id,taxRate:a.taxRate??"08",id:a.id},p=this.createInvoiceItemFormGroup();return p.patchValue(s),p}));this.editInvoiceForm.set(this.fb.group({client:[e.client,[d.required]],initDate:[E(new Date(e.initDate??new Date)),[d.required]],expireDate:[E(new Date(e.expireDate??new Date)),[]],currency:[e.currency??"USD",[d.required]],reference:[e.reference??"",[]],invoiceItems:t})),this.invoiceItems.controls.forEach(a=>{this.setupItemGroupValueChangeListener(a)}),this.invoiceItems&&this.invoiceItems.controls&&this.formInvoiceService.calculateTotals(this.invoiceItems)}validField(e){let t=this.editInvoiceForm()?.get(e);return t?t.touched&&t.invalid:!1}onExpireDateChange(e){this.editInvoiceForm()?.controls.expireDate.patchValue(e)}get invoiceItems(){return this.editInvoiceForm()?.get("invoiceItems")}createInvoiceItemFormGroup(){let e=this.fb.group({id:[null],itemId:[null,[d.required]],description:["",[]],quantity:[1,[d.required,d.min(1)]],price:["",[d.required]],discount:[0,[]],accountId:["",[d.required,d.minLength(1)]],taxRate:["08",[d.required,d.minLength(1)]]});return this.setupItemGroupValueChangeListener(e),e}addInvoiceItem(){this.invoiceItems.push(this.createInvoiceItemFormGroup()),this.formInvoiceService.calculateTotals(this.invoiceItems)}removeInvoiceItem(e){this.invoiceItems.removeAt(e),this.formInvoiceService.calculateTotals(this.invoiceItems)}setupItemGroupValueChangeListener(e){e.valueChanges.pipe(F(this.destroyRef),M(t=>t.quantity!==null&&t.price!==null&&t.discount!==null)).subscribe(()=>{let t=this.invoiceItems;t&&this.formInvoiceService.calculateTotals(t)})}onItemSelectedInRow(e,t){let a=this.invoiceItems.at(t);a&&e&&(a.patchValue({description:this.formInvoiceService.getCorrectDescriptionFromItemSelectedEmitter(this.invoice(),e),price:this.formInvoiceService.getCorrectPriceFromItemSelectedEmitter(this.invoice(),e),accountId:this.formInvoiceService.getCorrectAccountFromItemSelectedEmitter(this.invoice(),e)}),this.formInvoiceService.calculateTotals(this.invoiceItems))}onCustomSubmitBtnClicked(e){this.callToAction(e)}callToAction(e){if(this.formErrorService.throwFormErrors(this.editInvoiceForm()),!this.formInvoiceService.verifyInvoiceItems(this.invoiceItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.editInvoiceForm().controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.editInvoiceForm().invalid){this.formErrorService.throwFormErrors(this.editInvoiceForm());return}let t=this.editInvoiceForm().value;t.updatedAt=j(new Date),e==="edit"&&this.formInvoiceService.onEditAction(this.invoiceId(),t),e==="edit_and_send"&&(this.invoice()?.status==="borrador"&&(t.status="enviada"),this.formInvoiceService.handleCreateOrEditInvoiceSendingEmailAsWell(t,this.invoiceId()))}comeBackToList(){this.commonAdminService.comeBackToList("/list-invoices")}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=k({type:r,selectors:[["edit-invoice"]],decls:9,vars:1,consts:[[1,"main_content"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],[1,"d-flex","justify-content-between","align-items-end","mb-1"],["for","reference",1,"w_100"],[1,"fas","fa-tag"],["type","text","formControlName","reference"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","invoiceItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Editar","secondaryText","Editando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"]],template:function(t,a){t&1&&(n(0,"div",0)(1,"div",1)(2,"div",2)(3,"h3",3),o(4,"Editar factura"),i(),n(5,"h4",4),h("click",function(){return a.comeBackToList()}),l(6,"i",5),o(7," Regresar "),i()(),u(8,we,100,25,"form",6),i()()),t&2&&(c(8),v(a.editInvoiceForm()?8:-1))},dependencies:[V,R,G,pe,ae,K,ne,oe,Q,X,ie,H,J,Y,te,Z,ee,de,se,ue,ve],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{O as default};
