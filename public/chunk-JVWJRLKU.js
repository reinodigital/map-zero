import{a as ue}from"./chunk-MUR67HWB.js";import{a as pe}from"./chunk-VXINEJMA.js";import{b as de,c as fe}from"./chunk-KZ5EEZ6W.js";import"./chunk-4ZL7IQBX.js";import{a as ce,b as se}from"./chunk-KRH6V4OX.js";import"./chunk-G7SYGITX.js";import{a as E}from"./chunk-QVQJSET7.js";import{a as me}from"./chunk-F7754PKC.js";import{a as le}from"./chunk-T4UO7T6E.js";import{a as ae}from"./chunk-3L4S2P7E.js";import{a as re}from"./chunk-IETRKHQE.js";import{b as z,c,d as j,e as W,h as K,i as H,k as J,l as X,m as Y,n as Z,o as ee,p as te,q as ie,t as ne,u as oe}from"./chunk-XXXEA7T5.js";import{h as V,i as L,l as B,m as U,n as T,o as $}from"./chunk-ZUYKIS5S.js";import{i as O,m as P,n as R,q as G}from"./chunk-SF27WFEL.js";import{$a as d,Ab as C,Ba as k,C as A,Jb as n,Kb as w,Lb as x,Ma as l,Tb as h,Vb as b,Wa as q,ba as s,fb as p,gc as v,ia as N,ja as Q,kb as f,na as D,nb as y,ob as I,pb as t,qb as e,rb as m,vb as M,wa as g,zb as _}from"./chunk-BXSYLYWC.js";var Se=(a,i)=>i.id,ve=(a,i)=>i.code;function he(a,i){a&1&&(t(0,"small",13),n(1," cliente es requerido "),e())}function be(a,i){a&1&&(t(0,"small",13),n(1," fecha inicio es requerida "),e())}function ge(a,i){a&1&&(t(0,"small",13),n(1," item es requerido "),e())}function Ce(a,i){a&1&&(t(0,"small",13),n(1," cantidad debe ser > 0 "),e())}function we(a,i){a&1&&(t(0,"small",13),n(1," precio incorrecto "),e())}function xe(a,i){if(a&1&&(t(0,"option",56),n(1),e()),a&2){let o=i.$implicit;p("value",o.id),l(),x(" ",`${o.code} - ${o.name}`," ")}}function Ee(a,i){a&1&&(t(0,"small",13),n(1," contabilidad es requerido "),e())}function Ne(a,i){if(a&1&&(t(0,"option",56),n(1),e()),a&2){let o=i.$implicit;p("value",o.code),l(),w(o.label)}}function Qe(a,i){a&1&&(t(0,"small",13),n(1," impuesto es requerido "),e())}function ye(a,i){if(a&1){let o=M();t(0,"tr",48)(1,"td")(2,"custom-select",49),_("itemSelectedEmitter",function(u){let S=N(o).index,_e=C();return Q(_e.onItemSelectedInRow(u,S))}),e(),d(3,ge,2,0,"small",13),e(),t(4,"td"),m(5,"textarea",50),e(),t(6,"td"),m(7,"input",51),d(8,Ce,2,0,"small",13),e(),t(9,"td"),m(10,"input",52),d(11,we,2,0,"small",13),e(),t(12,"td"),m(13,"input",53),e(),t(14,"td")(15,"select",54)(16,"option",55),n(17,"--Seleccione--"),e(),y(18,xe,2,2,"option",56,Se),e(),d(20,Ee,2,0,"small",13),e(),t(21,"td")(22,"select",57),y(23,Ne,2,2,"option",56,ve),e(),d(25,Qe,2,0,"small",13),e(),t(26,"td"),m(27,"ng-select",58),e(),t(28,"td")(29,"button",59),_("click",function(){let u=N(o).index,S=C();return Q(S.removeQuoteItem(u))}),m(30,"i",60),e()()()}if(a&2){let o=i.index,r=C();p("formGroupName",o)("id","row_"+o),l(3),f(r.validField("quoteItems."+o+".itemId")?3:-1),l(5),f(r.validField("quoteItems."+o+".quantity")?8:-1),l(3),f(r.validField("quoteItems."+o+".price")?11:-1),l(7),I(r.accounts()),l(2),f(r.validField("quoteItems."+o+".accountId")?20:-1),l(3),I(r.taxRates),l(2),f(r.validField("quoteItems."+o+".taxRate")?25:-1),l(2),p("items",r.sellers())("searchable",!0)}}function Ie(a,i){a&1&&(t(0,"tr",27)(1,"td",61)(2,"small"),n(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),e()()())}function Te(a,i){a&1&&(t(0,"div",43),n(1," Enviando "),m(2,"div",62),e())}function Fe(a,i){a&1&&n(0," Enviar ")}var F=class a{platformId=s(k);fb=s(ne);destroyRef=s(D);authService=s(V);accountService=s(L);commonAdminService=s(le);clientService=s(B);formErrorService=s(ae);customToastService=s(re);sellers=g([]);accounts=g([]);formNewQuoteService=s(ue);isFormSubmitting=v(()=>this.formNewQuoteService.isFormSubmitting());taxRates=$;clients=g([]);newQuoteForm=this.fb.group({client:[null,[c.required]],initDate:[this.currentDate,[c.required]],expireDate:[this.dateInSevenDay,[]],currency:["USD",[c.required]],terms:["",[]],quoteItems:this.fb.array([this.createQuoteItemFormGroup(),this.createQuoteItemFormGroup()])});subtotal=v(()=>this.formNewQuoteService.subtotal());totalDiscount=v(()=>this.formNewQuoteService.totalDiscount());totalTax=v(()=>this.formNewQuoteService.totalTax());totalAmount=v(()=>this.formNewQuoteService.totalAmount());get isBrowser(){return G(this.platformId)}get currentDate(){return T(new Date)}get dateInSevenDay(){let i=new Date,o=new Date(new Date().setDate(i.getDate()+7));return T(o)}ngOnInit(){this.formNewQuoteService.cleanTotalValues(),this.fetchAllShortClients(),this.fetchSellers(),this.fetchAccounts(),this.quoteItems.controls.forEach(i=>{this.setupItemGroupValueChangeListener(i)})}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(E(this.destroyRef)).subscribe(i=>{i&&i.accounts&&this.accounts.set(i.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(E(this.destroyRef)).subscribe(i=>{i&&this.clients.set(i)})}fetchSellers(){this.authService.fetchAllSellers().subscribe(i=>{i&&i.length&&this.sellers.set(i)})}validField(i){let o=this.newQuoteForm.get(i);return o?o.touched&&o.invalid:!1}onExpireDateChange(i){this.newQuoteForm.controls.expireDate.patchValue(i)}get quoteItems(){return this.newQuoteForm.get("quoteItems")}createQuoteItemFormGroup(){let i=this.fb.group({itemId:[null,[c.required]],sellerUid:[null,[]],description:["",[]],quantity:[1,[c.required,c.min(1)]],price:["",[c.required]],discount:[0,[]],accountId:["",[c.required,c.minLength(1)]],taxRate:["08",[c.required,,c.minLength(1)]]});return this.setupItemGroupValueChangeListener(i),i}addQuoteItem(){this.quoteItems.push(this.createQuoteItemFormGroup()),this.formNewQuoteService.calculateTotals(this.quoteItems)}removeQuoteItem(i){this.quoteItems.removeAt(i),this.formNewQuoteService.calculateTotals(this.quoteItems)}setupItemGroupValueChangeListener(i){i.valueChanges.pipe(E(this.destroyRef),A(o=>o.quantity!==null&&o.price!==null&&o.discount!==null)).subscribe(()=>{this.formNewQuoteService.calculateTotals(this.quoteItems)})}onItemSelectedInRow(i,o){let r=this.quoteItems.at(o);r&&i&&(r.patchValue({description:i.description||"",price:i.salePrice??0,accountId:i.saleAccountId??""}),this.formNewQuoteService.calculateTotals(this.quoteItems))}onCustomSubmitBtnClicked(i){this.callToAction(i)}callToAction(i){if(this.formErrorService.throwFormErrors(this.newQuoteForm),!this.formNewQuoteService.verifyQuoteItems(this.quoteItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.newQuoteForm.controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.newQuoteForm.invalid){this.formErrorService.throwFormErrors(this.newQuoteForm);return}let o=this.newQuoteForm.value;switch(o.createdAt=U(new Date),i){case"save":o.status="borrador",o.action="save",this.formNewQuoteService.onSaveAction(o);break;case"mark_as_sent":o.status="enviada",o.action="mark_as_sent",this.formNewQuoteService.onSaveAction(o);break;case"send":o.status="borrador",o.action="send",this.formNewQuoteService.handleCreateOrEditQuoteSendingEmailAsWell(o);break;default:break}}comeBackToList(){this.commonAdminService.comeBackToList("/list-quotes")}static \u0275fac=function(o){return new(o||a)};static \u0275cmp=q({type:a,selectors:[["new-quote"]],decls:127,vars:30,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],["value","CRC"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","quoteItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"col-12"],["for","description"],["formControlName","terms","rows","2",1,"w_100"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Guardar","secondaryText","Guardando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[1,"input-group","ms-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"d-flex","align-items-center"],["type","button","data-bs-toggle","dropdown","aria-expanded","false",1,"btn","btn-outline-secondary","dropdown-toggle","dropdown-toggle-split"],[1,"visually-hidden"],[1,"dropdown-menu"],[1,"dropdown-item","cp",3,"click"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["bindLabel","name","bindValue","uid","placeholder","--Seleccione--","formControlName","sellerUid",3,"items","searchable"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"],[1,"spinner","ms-2"]],template:function(o,r){o&1&&(t(0,"div",0),m(1,"breadcrumb",1),t(2,"div",2)(3,"div",3)(4,"h3",4),n(5,"Nueva cotizaci\xF3n"),e(),t(6,"h4",5),_("click",function(){return r.comeBackToList()}),m(7,"i",6),n(8," Regresar "),e()(),t(9,"form",7)(10,"div",8)(11,"div",9)(12,"label",10),n(13," Cliente "),t(14,"span",11),n(15,"*"),e()(),m(16,"ng-select",12),d(17,he,2,0,"small",13),e(),t(18,"div",9)(19,"label",14),n(20," Fecha inicio "),t(21,"span",11),n(22,"*"),e()(),m(23,"input",15),d(24,be,2,0,"small",13),e(),t(25,"div",9)(26,"label",16),n(27," Fecha expira "),t(28,"span",17),n(29,"opcional"),e()(),t(30,"quick-date-picker",18),_("dateChanged",function(S){return r.onExpireDateChange(S)}),e()(),t(31,"div",9)(32,"label",16),n(33," Moneda "),t(34,"span",11),n(35,"*"),e()(),t(36,"select",19)(37,"option",20),n(38,"USD"),e(),t(39,"option",21),n(40,"Colones"),e()()()(),t(41,"table",22)(42,"thead")(43,"tr")(44,"th",23)(45,"label"),n(46,"Item"),e()(),t(47,"th",23)(48,"label"),n(49,"Descripci\xF3n"),e()(),t(50,"th",24)(51,"label"),n(52," Cantidad "),e()(),t(53,"th",24)(54,"label"),n(55,"Precio"),e()(),t(56,"th",24)(57,"label"),n(58,"Descuento (%)"),e()(),t(59,"th",24)(60,"label"),n(61,"Cuenta"),e()(),t(62,"th",24)(63,"label"),n(64,"Impuesto"),e()(),t(65,"th",24)(66,"label"),n(67,"Vendedor"),e()(),m(68,"th",24),e()(),t(69,"tbody",25),d(70,ye,31,9,"tr",26)(71,Ie,4,0,"tr",27),e()(),t(72,"button",28),_("click",function(){return r.addQuoteItem()}),m(73,"i",29),n(74," Agregar fila "),e(),t(75,"div",30)(76,"div",31)(77,"ul",32)(78,"li",33)(79,"span"),n(80,"Subtotal"),e(),t(81,"span"),n(82),h(83,"number"),e()(),t(84,"li",33)(85,"span"),n(86,"Descuento total"),e(),t(87,"span",13),n(88),h(89,"number"),e()(),t(90,"li",33)(91,"span"),n(92,"Impuesto total"),e(),t(93,"span"),n(94),h(95,"number"),e()(),m(96,"div",34),t(97,"li",35)(98,"span")(99,"span"),n(100,"Total"),e()(),t(101,"strong"),n(102),h(103,"number"),e()()()()(),t(104,"div",8)(105,"div",36)(106,"label",37),n(107," T\xE9rminos "),t(108,"span",17),n(109,"opcional"),e()(),m(110,"textarea",38),e()(),t(111,"div",39)(112,"submit-button",40),_("btnWasClicked",function(S){return r.onCustomSubmitBtnClicked(S)}),e(),t(113,"div",41)(114,"button",42),_("click",function(){return r.callToAction(r.formNewQuoteService.sendAction)}),d(115,Te,3,0,"div",43)(116,Fe,1,0),e(),t(117,"button",44)(118,"span",45),n(119,"Toggle Dropdown"),e()(),t(120,"ul",46)(121,"li")(122,"a",47),_("click",function(){return r.callToAction(r.formNewQuoteService.sendAction)}),n(123," Enviar "),e()(),t(124,"li")(125,"a",47),_("click",function(){return r.callToAction(r.formNewQuoteService.markAsSentAction)}),n(126," Marcar como enviada "),e()()()()()()()()),o&2&&(l(),p("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado cotizaciones")("secondaryLink","/list-quotes"),l(8),p("formGroup",r.newQuoteForm),l(7),p("items",r.clients())("searchable",!0),l(),f(r.validField("clientId")?17:-1),l(7),f(r.validField("initDate")?24:-1),l(46),p("ngForOf",r.quoteItems.controls),l(),f(r.quoteItems.value.length?-1:71),l(11),w(b(83,18,r.subtotal(),"1.2-2")),l(6),x(" - ",b(89,21,r.totalDiscount(),"1.2-2")," "),l(6),w(b(95,24,r.totalTax(),"1.2-2")),l(8),x(" ",b(103,27,r.totalAmount(),"1.2-2")," "),l(10),p("isFormSubmitting",r.isFormSubmitting())("buttonAction",r.formNewQuoteService.saveAction),l(3),f(r.formNewQuoteService.isFormNewQuoteAndEmailSubmitting()?115:116))},dependencies:[R,O,P,de,oe,K,te,ie,z,H,ee,j,W,J,Z,X,Y,se,ce,pe,fe,me],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{F as default};
