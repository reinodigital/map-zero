import{a as _e}from"./chunk-UEGWDIED.js";import"./chunk-NOTS5ZWT.js";import{b as he,c as fe}from"./chunk-OZFJSFYS.js";import{a as me,b as ue}from"./chunk-KRH6V4OX.js";import{a as pe}from"./chunk-4SDHRU2H.js";import"./chunk-G7SYGITX.js";import{a as P}from"./chunk-QVQJSET7.js";import{a as de}from"./chunk-T5DHTF52.js";import{a as se}from"./chunk-P3VFXC3H.js";import{a as ce}from"./chunk-3L4S2P7E.js";import{a as le}from"./chunk-IETRKHQE.js";import{b as H,c as h,d as J,e as K,h as Q,i as X,k as Y,l as Z,m as ee,n as te,o as re,p as ie,q as ne,t as oe,u as ae}from"./chunk-XXXEA7T5.js";import{c as L,h as B,i as U,l as $,m as j,n as E,o as W,y as z}from"./chunk-NXK32U4M.js";import{i as R,m as V,n as G,q}from"./chunk-SF27WFEL.js";import{$a as m,Ab as f,Ba as M,C as T,Jb as o,Kb as y,Lb as I,Ma as l,Tb as g,Vb as x,Wa as k,ba as d,fb as u,gc as b,ia as C,ja as S,kb as p,na as A,nb as w,ob as F,pb as r,qb as t,rb as c,vb as N,wa as O,zb as v}from"./chunk-BXSYLYWC.js";var ve=(a,e)=>e.id,Ce=(a,e)=>e.code;function Se(a,e){a&1&&(r(0,"small",14),o(1," cliente es requerido "),t())}function be(a,e){a&1&&(r(0,"small",14),o(1," fecha inicio es requerida "),t())}function ge(a,e){a&1&&(r(0,"small",14),o(1," item es requerido "),t())}function xe(a,e){a&1&&(r(0,"small",14),o(1," cantidad debe ser > 0 "),t())}function Ee(a,e){a&1&&(r(0,"small",14),o(1," precio incorrecto "),t())}function Pe(a,e){if(a&1&&(r(0,"option",57),o(1),t()),a&2){let i=e.$implicit;u("value",i.id),l(),I(" ",`${i.code} - ${i.name}`," ")}}function ye(a,e){a&1&&(r(0,"small",14),o(1," contabilidad es requerido "),t())}function Ie(a,e){if(a&1&&(r(0,"option",57),o(1),t()),a&2){let i=e.$implicit;u("value",i.code),l(),y(i.label)}}function we(a,e){a&1&&(r(0,"small",14),o(1," impuesto es requerido "),t())}function Fe(a,e){if(a&1){let i=N();r(0,"tr",49)(1,"td")(2,"custom-select",50),v("itemSelectedEmitter",function(s){let _=C(i).index,Oe=f(2);return S(Oe.onItemSelectedInRow(s,_))}),t(),m(3,ge,2,0,"small",14),t(),r(4,"td"),c(5,"textarea",51),t(),r(6,"td"),c(7,"input",52),m(8,xe,2,0,"small",14),t(),r(9,"td"),c(10,"input",53),m(11,Ee,2,0,"small",14),t(),r(12,"td"),c(13,"input",54),t(),r(14,"td")(15,"select",55)(16,"option",56),o(17,"--Seleccione--"),t(),w(18,Pe,2,2,"option",57,ve),t(),m(20,ye,2,0,"small",14),t(),r(21,"td")(22,"select",58),w(23,Ie,2,2,"option",57,Ce),t(),m(25,we,2,0,"small",14),t(),r(26,"td"),c(27,"ng-select",59),t(),r(28,"td")(29,"button",60),v("click",function(){let s=C(i).index,_=f(2);return S(_.removePurchaseOrderItem(s))}),c(30,"i",61),t()()()}if(a&2){let i=e.index,n=f(2);u("formGroupName",i)("id","row_"+i),l(3),p(n.validField("purchaseOrderItems."+i+".itemId")?3:-1),l(5),p(n.validField("purchaseOrderItems."+i+".quantity")?8:-1),l(3),p(n.validField("purchaseOrderItems."+i+".price")?11:-1),l(7),F(n.accounts()),l(2),p(n.validField("purchaseOrderItems."+i+".accountId")?20:-1),l(3),F(n.taxRates),l(2),p(n.validField("purchaseOrderItems."+i+".taxRate")?25:-1),l(2),u("items",n.sellers())("searchable",!0)}}function Ne(a,e){a&1&&(r(0,"tr",32)(1,"td",62)(2,"small"),o(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),t()()())}function De(a,e){a&1&&(r(0,"div",48),o(1," Editando y enviando "),c(2,"div",63),t())}function Te(a,e){a&1&&o(0," Editar y enviar ")}function Ae(a,e){if(a&1){let i=N();r(0,"form",7)(1,"div",9)(2,"div",10)(3,"label",11),o(4," Cliente "),r(5,"span",12),o(6,"*"),t()(),c(7,"ng-select",13),m(8,Se,2,0,"small",14),t(),r(9,"div",10)(10,"label",15),o(11," Fecha inicio "),r(12,"span",12),o(13,"*"),t()(),c(14,"input",16),m(15,be,2,0,"small",14),t(),r(16,"div",10)(17,"label",17),o(18," Fecha entrega "),r(19,"span",18),o(20,"opcional"),t()(),c(21,"input",19),t(),r(22,"div",10)(23,"label",20),o(24," Moneda "),r(25,"span",12),o(26,"*"),t()(),r(27,"select",21)(28,"option",22),o(29,"USD"),t(),r(30,"option",23),o(31,"Colones"),t()()(),r(32,"div",10)(33,"div",24)(34,"label",25),o(35," N\xFAmero orden de compra "),t(),r(36,"span"),o(37,"#"),t()(),c(38,"input",26),t()(),r(39,"table",27)(40,"thead")(41,"tr")(42,"th",28)(43,"label"),o(44,"Item"),t()(),r(45,"th",28)(46,"label"),o(47,"Descripci\xF3n"),t()(),r(48,"th",29)(49,"label"),o(50," Cantidad "),t()(),r(51,"th",29)(52,"label"),o(53,"Precio"),t()(),r(54,"th",29)(55,"label"),o(56,"Descuento (%)"),t()(),r(57,"th",29)(58,"label"),o(59,"Cuenta"),t()(),r(60,"th",29)(61,"label"),o(62,"Impuesto"),t()(),r(63,"th",29)(64,"label"),o(65,"Vendedor"),t()(),c(66,"th",29),t()(),r(67,"tbody",30),m(68,Fe,31,9,"tr",31)(69,Ne,4,0,"tr",32),t()(),r(70,"button",33),v("click",function(){C(i);let s=f();return S(s.addPurchaseOrderItem())}),c(71,"i",34),o(72," Agregar fila "),t(),r(73,"div",35)(74,"div",36)(75,"ul",37)(76,"li",38)(77,"span"),o(78,"Subtotal"),t(),r(79,"span"),o(80),g(81,"number"),t()(),r(82,"li",38)(83,"span"),o(84,"Descuento total"),t(),r(85,"span",14),o(86),g(87,"number"),t()(),r(88,"li",38)(89,"span"),o(90,"Impuesto total"),t(),r(91,"span"),o(92),g(93,"number"),t()(),c(94,"div",39),r(95,"li",40)(96,"span")(97,"span"),o(98,"Total"),t()(),r(99,"strong"),o(100),g(101,"number"),t()()()()(),r(102,"div",9)(103,"div",41)(104,"label",42),o(105," Instrucciones de entrega "),r(106,"span",18),o(107,"opcional"),t()(),c(108,"textarea",43),t()(),r(109,"div",44)(110,"submit-button",45),v("btnWasClicked",function(s){C(i);let _=f();return S(_.onCustomSubmitBtnClicked(s))}),t(),r(111,"div",46)(112,"button",47),v("click",function(){C(i);let s=f();return S(s.callToAction(s.formNewPurchaseOrderService.editAndSendAction))}),m(113,De,3,0,"div",48)(114,Te,1,0),t()()()()}if(a&2){let i,n=f();u("formGroup",n.editPurchaseOrderForm()),l(7),u("items",n.clients())("searchable",!0),l(),p(n.validField("clientId")?8:-1),l(7),p(n.validField("initDate")?15:-1),l(23),u("value",(i=n.purchaseOrder())==null?null:i.purchaseOrderNumber),l(30),u("ngForOf",n.purchaseOrderItems.controls),l(),p(n.purchaseOrderItems.value.length?-1:69),l(11),y(x(81,15,n.subtotal(),"1.2-2")),l(6),I(" - ",x(87,18,n.totalDiscount(),"1.2-2")," "),l(6),y(x(93,21,n.totalTax(),"1.2-2")),l(8),I(" ",x(101,24,n.totalAmount(),"1.2-2")," "),l(10),u("isFormSubmitting",n.isFormSubmitting())("buttonAction",n.formNewPurchaseOrderService.editAction),l(3),p(n.formNewPurchaseOrderService.isFormNewPurchaseOrderAndEmailSubmitting()?113:114)}}function Me(a,e){if(a&1&&c(0,"tracking-entity",8),a&2){let i=f();u("tracking",i.purchaseOrder().tracking)("entity",i.entityData())}}var D=class a{platformId=d(M);fb=d(oe);destroyRef=d(A);activatedRoute=d(L);authService=d(B);accountService=d(U);commonAdminService=d(se);purchaseOrderService=d(z);clientService=d($);formErrorService=d(ce);customToastService=d(le);sellers=O([]);accounts=O([]);entityData=O(null);purchaseOrderId=O(null);purchaseOrder=O(null);formNewPurchaseOrderService=d(_e);isFormSubmitting=b(()=>this.formNewPurchaseOrderService.isFormSubmitting());taxRates=W;clients=O([]);editPurchaseOrderForm=O(null);subtotal=b(()=>this.formNewPurchaseOrderService.subtotal());totalDiscount=b(()=>this.formNewPurchaseOrderService.totalDiscount());totalTax=b(()=>this.formNewPurchaseOrderService.totalTax());totalAmount=b(()=>this.formNewPurchaseOrderService.totalAmount());get isBrowser(){return q(this.platformId)}get currentDate(){return E(new Date)}get dateInSevenDay(){let e=new Date,i=new Date(new Date().setDate(e.getDate()+7));return E(i)}constructor(){this.purchaseOrderId.set(this.activatedRoute.snapshot.params.id),this.entityData.set({refEntity:"PurchaseOrder",refEntityId:this.purchaseOrderId()})}ngOnInit(){this.fetchAllShortClients(),this.fetchSellers(),this.fetchAccounts(),this.fetchPurchaseOrderById()}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(P(this.destroyRef)).subscribe(e=>{e&&e.accounts&&this.accounts.set(e.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(P(this.destroyRef)).subscribe(e=>{e&&this.clients.set(e)})}fetchSellers(){this.authService.fetchAllSellers().subscribe(e=>{e&&e.length&&this.sellers.set(e)})}fetchPurchaseOrderById(){this.purchaseOrderService.fetchOne(this.purchaseOrderId()).pipe(P(this.destroyRef)).subscribe(e=>{e&&e.id&&(this.purchaseOrder.set(e),this.fillOutPurchaseOrderForm())})}fillOutPurchaseOrderForm(){let e=this.purchaseOrder(),i=this.fb.array(e.purchaseOrderItems.map(n=>{let s={itemId:n.item.id,sellerUid:n.seller?.uid||null,description:n.description??"",quantity:n.quantity,price:n.price,discount:n.discount??0,accountId:n.account?.id,taxRate:n.taxRate??"08",id:n.id},_=this.createPurchaseOrderItemFormGroup();return _.patchValue(s),_}));this.editPurchaseOrderForm.set(this.fb.group({client:[e.client,[h.required]],initDate:[E(new Date(e.initDate??new Date)),[h.required]],deliveryDate:[E(new Date(e.deliveryDate??new Date)),[]],currency:[e.currency??"USD",[h.required]],deliveryInstructions:[e.deliveryInstructions??"",[]],purchaseOrderItems:i})),this.purchaseOrderItems.controls.forEach(n=>{this.setupItemGroupValueChangeListener(n)}),this.purchaseOrderItems&&this.purchaseOrderItems.controls&&this.formNewPurchaseOrderService.calculateTotals(this.purchaseOrderItems)}validField(e){let i=this.editPurchaseOrderForm()?.get(e);return i?i.touched&&i.invalid:!1}get purchaseOrderItems(){return this.editPurchaseOrderForm()?.get("purchaseOrderItems")}createPurchaseOrderItemFormGroup(){let e=this.fb.group({id:[null],itemId:[null,[h.required]],sellerUid:[null,[]],description:["",[]],quantity:[1,[h.required,h.min(1)]],price:["",[h.required]],discount:[0,[]],accountId:["",[h.required,h.minLength(1)]],taxRate:["08",[h.required,h.minLength(1)]]});return this.setupItemGroupValueChangeListener(e),e}addPurchaseOrderItem(){this.purchaseOrderItems.push(this.createPurchaseOrderItemFormGroup()),this.formNewPurchaseOrderService.calculateTotals(this.purchaseOrderItems)}removePurchaseOrderItem(e){this.purchaseOrderItems.removeAt(e),this.formNewPurchaseOrderService.calculateTotals(this.purchaseOrderItems)}setupItemGroupValueChangeListener(e){e.valueChanges.pipe(P(this.destroyRef),T(i=>i.quantity!==null&&i.price!==null&&i.discount!==null)).subscribe(()=>{let i=this.purchaseOrderItems;i&&this.formNewPurchaseOrderService.calculateTotals(i)})}onItemSelectedInRow(e,i){let n=this.purchaseOrderItems.at(i);n&&e&&(n.patchValue({description:this.formNewPurchaseOrderService.getCorrectDescriptionFromItemSelectedEmitter(this.purchaseOrder(),e),price:this.formNewPurchaseOrderService.getCorrectPriceFromItemSelectedEmitter(this.purchaseOrder(),e),accountId:this.formNewPurchaseOrderService.getCorrectAccountFromItemSelectedEmitter(this.purchaseOrder(),e)}),this.formNewPurchaseOrderService.calculateTotals(this.purchaseOrderItems))}onCustomSubmitBtnClicked(e){this.callToAction(e)}callToAction(e){if(this.formErrorService.throwFormErrors(this.editPurchaseOrderForm()),!this.formNewPurchaseOrderService.verifyPurchaseOrderItems(this.purchaseOrderItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.editPurchaseOrderForm().controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.editPurchaseOrderForm().invalid){this.formErrorService.throwFormErrors(this.editPurchaseOrderForm());return}let i=this.editPurchaseOrderForm().value;i.updatedAt=j(new Date),e==="edit"&&this.formNewPurchaseOrderService.onEditAction(this.purchaseOrderId(),i),e==="edit_and_send"&&(this.purchaseOrder()?.status==="borrador"&&(i.status="enviada"),this.formNewPurchaseOrderService.handleCreateOrEditPurchaseOrderSendingEmailAsWell(i,this.purchaseOrderId()))}comeBackToList(){this.commonAdminService.comeBackToList("/list-purchase-order")}static \u0275fac=function(i){return new(i||a)};static \u0275cmp=k({type:a,selectors:[["edit-purchase-order"]],decls:11,vars:6,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[3,"tracking","entity"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","deliveryDate",1,"w_100"],[1,"muted"],["type","date","formControlName","deliveryDate"],["for","currency",1,"w_100"],["formControlName","currency"],["value","USD"],["value","CRC"],[1,"d-flex","justify-content-between","align-items-end"],["for","purchaseOrderNumber",1,"w_100"],["type","text","disabled","",3,"value"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","purchaseOrderItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"col-12"],["for","deliveryInstructions"],["formControlName","deliveryInstructions","rows","2",1,"w_100"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Editar","secondaryText","Editando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[1,"input-group","ms-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"d-flex","align-items-center"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["bindLabel","name","bindValue","uid","placeholder","--Seleccione--","formControlName","sellerUid",3,"items","searchable"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"],[1,"spinner","ms-2"]],template:function(i,n){i&1&&(r(0,"div",0),c(1,"breadcrumb",1),r(2,"div",2)(3,"div",3)(4,"h3",4),o(5,"Editar orden de compra"),t(),r(6,"h4",5),v("click",function(){return n.comeBackToList()}),c(7,"i",6),o(8," Regresar "),t()(),m(9,Ae,115,27,"form",7),t()(),m(10,Me,1,2,"tracking-entity",8)),i&2&&(l(),u("primaryText","Vista de compras")("primaryLink","/purchases-overview")("secondaryText","Listado \xF3rdenes de compra")("secondaryLink","/list-purchase-orders"),l(8),p(n.editPurchaseOrderForm()?9:-1),l(),p(n.purchaseOrder()?10:-1))},dependencies:[G,R,V,he,ae,Q,ie,ne,H,X,re,J,K,Y,te,Z,ee,ue,me,fe,de,pe],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{D as default};
