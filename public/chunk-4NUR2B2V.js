import{a as ut}from"./chunk-YAGYQ226.js";import{w as ct}from"./chunk-UYDUL6F7.js";import{a as T}from"./chunk-KGOR65YN.js";import{a as lt}from"./chunk-QULINWIQ.js";import{a as rt,b as A,d as Q,g as F,j as O,u as P}from"./chunk-7DSSDOH7.js";import{B as q,D as ot,I as st,J as at,j as it,r as nt}from"./chunk-GCLW45SM.js";import{C as z,G as B,Ib as c,Jb as V,Kb as D,La as l,Lb as et,S as $,U as N,Va as S,W as j,X as W,_a as k,ba as u,db as H,eb as _,gb as K,hb as X,ia as G,ja as J,jb as x,mb as Y,na as E,nb as Z,ob as s,p as L,pb as a,qb as v,sa as C,ta as h,ub as tt,wa as r,yb as m,zb as I}from"./chunk-QAVPLLNK.js";var d=o=>parseFloat(o.toFixed(2));var mt=class o{router=u(nt);dialog=u(ct);customToastService=u(lt);quoteService=u(at);isFormSubmitting=r(!1);isFormNewQuoteAndEmailSubmitting=r(!1);saveAction="save";sendAction="send";markAsSentAction="mark_as_sent";editAction="edit";editAndSendAction="edit_and_send";subtotal=r(0);totalDiscount=r(0);totalTax=r(0);totalAmount=r(0);cleanTotalValues(){this.subtotal.set(0),this.totalDiscount.set(0),this.totalTax.set(0),this.totalAmount.set(0)}calculateTotals(t){let e=t.controls.reduce((b,g)=>{let y=g.get("quantity")?.value||0,f=g.get("price")?.value||0;return b+y*d(f)},0),i=t.controls.reduce((b,g)=>{let y=g.get("quantity")?.value||0,f=g.get("price")?.value||0,w=d(f),M=g.get("discount")?.value||0,R=y*w*M/100;return b+R},0),n=d(e)-d(i),p=0;t.controls.forEach(b=>{let g=b.get("quantity")?.value||0,y=b.get("price")?.value||0,f=d(y),w=b.get("discount")?.value||0,M=g*f*w/100,R=b.get("taxRate")?.value||"08",bt=g*f-M;p+=bt*ot(R)/100}),this.subtotal.set(d(e)),this.totalDiscount.set(d(i)),this.totalTax.set(d(p)),this.totalAmount.set(d(n+p))}verifyQuoteItems(t){return t.controls.every(e=>this.isQuoteItemValid(e))}isQuoteItemValid(t){let e=t.get("quantity")?.value,i=t.get("price")?.value,n=t.get("itemId")?.value;return e>=1&&i>0&&!!n}onSaveAction(t){this.isFormSubmitting.set(!0),this.quoteService.create(t).subscribe(e=>{e&&e.id?(this.customToastService.add({message:`Cotizaci\xF3n generada con estado ${e.status} correctamente.`,type:"success",duration:5e3}),this.router.navigateByUrl(`/detail-quote/${e.id}`)):this.customToastService.add({message:e.message,type:"error",duration:5e3}),this.isFormSubmitting.set(!1)})}onEditAction(t,e){this.isFormSubmitting.set(!0),this.quoteService.update(t,e).subscribe(i=>{i&&i.id?(this.customToastService.add({message:"Cotizaci\xF3n actualizada correctamente.",type:"success",duration:5e3}),this.router.navigateByUrl(`/detail-quote/${i.id}`)):this.customToastService.add({message:i.message,type:"error",duration:5e3}),this.isFormSubmitting.set(!1)})}handleCreateOrEditQuoteSendingEmailAsWell(t,e=null){let i={clientName:t.client.name,currency:t.currency,terms:t.terms,total:this.totalAmount()},n=this.dialog.open(ut,{width:"70rem",autoFocus:!1,data:i});n.updatePosition({top:"100px"}),n.afterClosed().subscribe(p=>{p&&(e?this.onEditQuoteSendingEmail(e,t,JSON.parse(p)):this.onCreateNewQuoteSendingEmail(t,JSON.parse(p)))})}onCreateNewQuoteSendingEmail(t,e){this.quoteService.create(t).subscribe(i=>{i&&i.id?(this.customToastService.add({message:`Cotizaci\xF3n generada con estado ${t.status} correctamente.`,type:"success",duration:8e3}),this.sendQuoteEmail(i.id,e)):this.customToastService.add({message:i.message,type:"error",duration:8e3})})}onEditQuoteSendingEmail(t,e,i){this.quoteService.update(t,e).subscribe(n=>{n&&n.id?(this.customToastService.add({message:"Cotizaci\xF3n actualizada correctamente.",type:"success",duration:8e3}),this.sendQuoteEmail(n.id,i)):this.customToastService.add({message:n.message,type:"error",duration:8e3})})}sendQuoteEmail(t,e){this.isFormNewQuoteAndEmailSubmitting.set(!0),this.quoteService.sendEmail(t,e).subscribe(i=>{i&&i.msg?this.customToastService.add({message:i.msg,type:"success",duration:5e3}):this.customToastService.add({message:i.message,type:"error",duration:5e3}),this.isFormNewQuoteAndEmailSubmitting.set(!1),this.router.navigateByUrl("/detail-quote/"+t)})}getCorrectPriceFromItemSelectedEmitter(t,e){let i=t?.quoteItems.find(n=>n.item.id===e.id);return e.isLoadingExistingItem?i?.price??0:e.salePrice}getCorrectAccountFromItemSelectedEmitter(t,e){let i=t?.quoteItems.find(n=>n.item.id===e.id);return e.isLoadingExistingItem?i?.account?.id??"":e.saleAccountId??""}getCorrectDescriptionFromItemSelectedEmitter(t,e){let i=t?.quoteItems.find(n=>n.item.id===e.id);return e.isLoadingExistingItem?i?.description??"":e.description??""}static \u0275fac=function(e){return new(e||o)};static \u0275prov=W({token:o,factory:o.\u0275fac,providedIn:"root"})};var Ct=(o,t)=>t.name;function St(o,t){if(o&1){let e=tt();s(0,"li",4),m("click",function(){let n=G(e).$implicit,p=I(2);return J(p.selectItem(n))}),s(1,"div",5)(2,"span",6),c(3),a(),s(4,"span",7),c(5),a(),s(6,"span",8),c(7),a()()()}if(o&2){let e=t.$implicit;l(3),V(e.cabys),l(2),V(e.shortName),l(2),D(" ",e.shortName," ")}}function _t(o,t){if(o&1&&(s(0,"ul",2),Y(1,St,8,3,"li",3,Ct),a()),o&2){let e=I();l(),Z(e.items())}}var dt=class o{destroyRef=u(E);itemService=u(st);searchControl=new F("");items=r([]);selectedItem=r("");notResultsString="sin resultados encontrados";_isSelectingItem=r(!1);_isInitialLoad=r(!0);itemSelectedEmitter=C();onChange=()=>{};onTouched=()=>{};isDisabled=!1;ngOnInit(){this.setupSearchControlListener()}writeValue(t){if(t==null){this.searchControl.setValue("",{emitEvent:!1}),this._isInitialLoad.set(!1);return}this._isSelectingItem.set(!0),typeof t=="number"?this.itemService.findOneAsSuggestion(t).pipe(T(this.destroyRef),N(()=>this._isSelectingItem.set(!0))).subscribe({next:e=>{e&&e.id?(this.searchControl.setValue(e.shortName,{emitEvent:!1}),this.selectedItem.set(e.name),this._isInitialLoad()&&(e.isLoadingExistingItem=!0,this.itemSelectedEmitter.emit(e),this.onChange(e.id))):(this.searchControl.setValue("",{emitEvent:!1}),this.selectedItem.set(""),this.onChange(null))},error:e=>{this.searchControl.setValue("",{emitEvent:!1}),this.selectedItem.set(""),this.onChange(null)},complete:()=>{this._isInitialLoad.set(!1),this._isSelectingItem.set(!1)}}):typeof t=="string"?(this.searchControl.setValue(t,{emitEvent:!1}),this.selectedItem.set(t),this._isInitialLoad.set(!1),this._isSelectingItem.set(!1)):(this.searchControl.setValue("",{emitEvent:!1}),this.selectedItem.set(""),this._isInitialLoad.set(!1),this._isSelectingItem.set(!1))}registerOnChange(t){this.onChange=t}registerOnTouched(t){this.onTouched=t}setDisabledState(t){this.isDisabled=t,t?this.searchControl.disable():this.searchControl.enable()}setupSearchControlListener(){this.searchControl.valueChanges.pipe(T(this.destroyRef),z(t=>typeof t=="string"&&!this._isSelectingItem()),B(500),N(t=>this.onTouched()),$(t=>{let e=t?t.trim():"";return!e||e.length<3?(this.items.set([]),this.selectedItem()!==""&&(this.onChange(null),this.itemSelectedEmitter.emit(null)),this.selectedItem.set(""),L([])):this.itemService.getSuggestions(e)})).subscribe(t=>{t.length===1&&t[0].name===this.notResultsString?(this.items.set(t),setTimeout(()=>{this.items.set([])},2e3)):this.items.set(t)})}selectItem(t){t.id&&(this._isSelectingItem.set(!0),this.searchControl.setValue(t.shortName,{emitEvent:!1}),this.selectedItem.set(t.shortName),this.items.set([]),this.onChange(t.id),this.onTouched(),this.itemSelectedEmitter.emit(t),setTimeout(()=>{this._isSelectingItem.set(!1)},50))}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=S({type:o,selectors:[["custom-select"]],outputs:{itemSelectedEmitter:"itemSelectedEmitter"},features:[et([{provide:rt,useExisting:j(()=>o),multi:!0}])],decls:3,vars:2,consts:[[1,"custom_select"],["type","text",3,"formControl"],[1,"suggestions"],[1,"suggestion_item"],[1,"suggestion_item",3,"click"],[1,"d-flex","flex-column"],[1,"suggestion_item_cabys"],[1,"suggestion_item_name"],[1,"suggestion_item_name_little"]],template:function(e,i){e&1&&(s(0,"div",0),v(1,"input",1),k(2,_t,3,0,"ul",2),a()),e&2&&(l(),_("formControl",i.searchControl),l(),x(i.items().length?2:-1))},dependencies:[P,A,Q,O],styles:[".custom_select[_ngcontent-%COMP%]{position:relative}ul.suggestions[_ngcontent-%COMP%]{list-style-type:none;padding:0;margin:0;position:absolute;top:3.2rem;left:0;width:40rem;box-shadow:0 2px 5px #0000001a;background-color:var(--background);border:2px solid var(--black);z-index:980}li[_ngcontent-%COMP%]{cursor:pointer;color:var(--black);font-size:1.3rem;padding:10px}li[_ngcontent-%COMP%]:hover{background-color:var(--light)}li[_ngcontent-%COMP%]:last-child{border-bottom:none}li[_ngcontent-%COMP%]   .suggestion_item_cabys[_ngcontent-%COMP%]{font-size:1.1rem;color:var(--text);background-color:var(--white);border-radius:.4rem;border:1px solid var(--black);padding:0rem .2rem;width:fit-content}li[_ngcontent-%COMP%]   .suggestion_item_name[_ngcontent-%COMP%]{color:var(--black);font-size:1.6rem;font-weight:500;margin-top:.5rem}li[_ngcontent-%COMP%]   .suggestion_item_name_little[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:400;color:var(--text)}"],changeDetection:0})};var gt=class o{destroyRef=u(E);dateControl=new F(this.dateInSevenDay,[]);optionsAreOpen=r(!1);dateChanged=C();get dateInSevenDay(){let t=new Date,e=new Date(new Date().setDate(t.getDate()+7));return q(e)}ngOnInit(){this.dateControl.valueChanges.pipe(T(this.destroyRef)).subscribe(t=>{this.dateChanged.emit(t)})}setDate(t){let e=new Date,i=new Date(e.setDate(e.getDate()+t)),n=q(i);n&&this.dateControl.patchValue(n),this.optionsAreOpen.set(!1)}toggleOptions(){this.optionsAreOpen.set(!this.optionsAreOpen())}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=S({type:o,selectors:[["quick-date-picker"]],outputs:{dateChanged:"dateChanged"},decls:17,vars:3,consts:[[1,"date_custom"],[1,"date_picker"],["type","date",3,"formControl"],[1,"fa-regular","fa-square-caret-down","fs-1","ms-3",3,"click"],[1,"date_options"],[1,"date_options_li",3,"click"],[1,"date_options_li_span","ms-3"]],template:function(e,i){e&1&&(s(0,"div",0)(1,"div",1),v(2,"input",2),s(3,"i",3),m("click",function(){return i.toggleOptions()}),a()(),s(4,"ul",4)(5,"li",5),m("click",function(){return i.setDate(0)}),s(6,"span",6),c(7,"Hoy"),a()(),s(8,"li",5),m("click",function(){return i.setDate(7)}),s(9,"span",6),c(10,"En 7 d\xEDas"),a()(),s(11,"li",5),m("click",function(){return i.setDate(14)}),s(12,"span",6),c(13,"En 14 d\xEDas"),a()(),s(14,"li",5),m("click",function(){return i.setDate(30)}),s(15,"span",6),c(16,"En 30 d\xEDas"),a()()()()),e&2&&(l(2),_("formControl",i.dateControl),l(2),K("hidden",!i.optionsAreOpen()))},dependencies:[it,P,A,Q,O],styles:[".date_custom[_ngcontent-%COMP%]{position:relative}.date_picker[_ngcontent-%COMP%]{display:flex;align-items:center;padding-top:.4rem}.date_options[_ngcontent-%COMP%]{display:block;background-color:var(--light);position:absolute;top:3rem;width:100%;transition:display .3s ease-in-out}.date_options_li[_ngcontent-%COMP%]{cursor:pointer;font-size:1.5rem}.date_options_li[_ngcontent-%COMP%]:hover{background-color:var(--gray)}.hidden[_ngcontent-%COMP%]{display:none}"],changeDetection:0})};function vt(o,t){if(o&1&&(s(0,"div",1),c(1),v(2,"div",2),a()),o&2){let e=I();l(),D(" ",e.secondaryText()," ")}}function It(o,t){if(o&1&&c(0),o&2){let e=I();D(" ",e.primaryText()," ")}}var ht=class o{isFormSubmitting=h.required();primaryText=h.required();secondaryText=h.required();attributeName=h(null);attributeClass=h(null);attributeType=h("button");buttonAction=h(null);actionToApply=h(null);btnWasClicked=C();onClick(){this.attributeType()==="submit"||!this.buttonAction()||this.btnWasClicked.emit(this.buttonAction())}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=S({type:o,selectors:[["submit-button"]],inputs:{isFormSubmitting:[1,"isFormSubmitting"],primaryText:[1,"primaryText"],secondaryText:[1,"secondaryText"],attributeName:[1,"attributeName"],attributeClass:[1,"attributeClass"],attributeType:[1,"attributeType"],buttonAction:[1,"buttonAction"],actionToApply:[1,"actionToApply"]},outputs:{btnWasClicked:"btnWasClicked"},decls:3,vars:6,consts:[[3,"click","disabled"],[1,"d-flex","align-items-center"],[1,"spinner","ms-2"]],template:function(e,i){if(e&1&&(s(0,"button",0),m("click",function(){return i.attributeType()==="button"&&i.onClick()}),k(1,vt,3,1,"div",1)(2,It,1,1),a()),e&2){let n;X((n=i.attributeClass())!==null&&n!==void 0?n:"btn btn-success"),_("disabled",i.isFormSubmitting()),H("type",i.attributeType())("name",i.attributeName()),l(),x(i.isFormSubmitting()?1:2)}},styles:[".responsive_btn[_ngcontent-%COMP%]{margin-top:.6rem}@media (min-width: 768px){.responsive_btn[_ngcontent-%COMP%]{margin-top:1.2rem}}"],changeDetection:0})};export{mt as a,dt as b,gt as c,ht as d};
