import{a as x}from"./chunk-XQLDNQDO.js";import{a as w}from"./chunk-7FLAGI4M.js";import{u as F,v as q,w as P}from"./chunk-G7SYGITX.js";import{a as _}from"./chunk-QVQJSET7.js";import{a as v}from"./chunk-IETRKHQE.js";import{u as Q}from"./chunk-XXXEA7T5.js";import{e as R,m as p,p as T,q as E,x as b}from"./chunk-NXK32U4M.js";import{Jb as l,Lb as M,Ma as A,Ra as y,Wa as D,X as I,ba as a,j as S,na as k,pb as r,qb as s,wa as d,zb as m}from"./chunk-BXSYLYWC.js";var g=class n{constructor(e){this.data=e;this.quote.set(e)}dialogRef=a(F);destroyRef=a(k);router=a(R);quoteService=a(b);customToastService=a(v);quote=d(null);markAsInvoiced=d(!1);closePopUp(){this.dialogRef.close()}onChangeMark(){this.markAsInvoiced.set(!this.markAsInvoiced())}createInvoice(){let e={createdAt:p(new Date),markAsInvoiced:this.markAsInvoiced()};this.quoteService.copyToInvoice(this.quote().id,e).pipe(_(this.destroyRef)).subscribe(t=>{t&&t.id?(this.customToastService.add({message:"Factura como borrador generada correctamente.",type:"success",duration:5e3}),this.closePopUp(),this.router.navigateByUrl(`/edit-invoice/${t.id}`)):this.customToastService.add({message:t.message,type:"error",duration:5e3})})}static \u0275fac=function(t){return new(t||n)(y(q))};static \u0275cmp=D({type:n,selectors:[["modal-create-invoice-from-quote"]],decls:16,vars:1,consts:[[1,"modal_create_invoice","p-4"],[1,"d-flex","justify-content-between","align-items-center","mb-3"],[1,"fa-solid","fa-xmark","fs-3",3,"click"],[1,"row","mt-3"],[1,"col-12"],[1,"form-check","form-switch"],["type","checkbox","id","flexSwitchCheckDefault",1,"form-check-input","cp",3,"change"],[1,"d-flex","justify-content-end","w_100","gap-3","mt-5"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"]],template:function(t,i){if(t&1&&(r(0,"div",0)(1,"div",1)(2,"h3"),l(3),s(),r(4,"i",2),m("click",function(){return i.closePopUp()}),s()(),r(5,"div",3)(6,"div",4)(7,"div",5)(8,"input",6),m("change",function(){return i.onChangeMark()}),s(),r(9,"span"),l(10,"Marcar como facturada"),s()()()(),r(11,"div",7)(12,"button",8),m("click",function(){return i.closePopUp()}),l(13," Cancelar "),s(),r(14,"button",9),m("click",function(){return i.createInvoice()}),l(15," Crear "),s()()()),t&2){let o;A(3),M("Crear factura por ",(o=i.quote())==null?null:o.quoteNumber,"")}},dependencies:[Q],encapsulation:2,changeDetection:0})};var U=class n{dialog=a(P);quoteService=a(b);customToastService=a(v);_statusChange$=new S;statusChange$=this._statusChange$.asObservable();isSendEmailFromDetailComponentSubmitting=d(!1);triggerStatusChange(){this._statusChange$.next()}calculateTotalsOnDetail(e){let{subtotal:t,discounts:i,iva:o}=e.reduce((u,c)=>{let h=c.quantity*c.price,C=c.quantity*(c.price*c.discount/100),j=(h-C)*(T(c.taxRate??"08")/100);return{subtotal:u.subtotal+h,discounts:u.discounts+C,iva:u.iva+j}},{subtotal:0,discounts:0,iva:0}),f=t-i+o;return{iva:o,discounts:i,subtotal:t,total:f}}getTaxRateLabel(e){return E(e)}getStatusBadgeFromQuote(e){let t="badge bg-label-light";switch(e){case"borrador":t="badge bg-label-light";break;case"enviada":t="badge bg-label-primary";break;case"aceptada":t="badge bg-label-success";break;case"rechazada":t="badge bg-label-danger";break;case"facturada":t="badge bg-label-warning";break;case"removida":t="badge bg-label-removed";break;default:break}return t}displayModalQuoteEmail(e){let t={clientName:e.client.name,currency:e.currency,terms:e.terms,total:e.total},i=this.dialog.open(x,{width:"70rem",autoFocus:!1,data:t});i.updatePosition({top:"100px"}),i.afterClosed().subscribe(o=>{if(o){this.isSendEmailFromDetailComponentSubmitting.set(!0);let f=JSON.parse(o);this.quoteService.sendEmail(e.id,f).subscribe(u=>this.processResponse(u))}})}markAsSent(e){this.quoteService.markAsSent(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}markAsAccepted(e){this.quoteService.markAsAccepted(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}markAsDeclined(e){this.quoteService.markAsDeclined(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}markAsInvoiced(e){this.quoteService.markAsInvoiced(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}undoMarkAsAccepted(e){this.quoteService.undoMarkAsAccepted(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}undoMarkAsDeclined(e){this.quoteService.undoMarkAsDeclined(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}undoMarkAsInvoiced(e){this.quoteService.undoMarkAsInvoiced(e,this.generateUpdatedAtProperty()).subscribe(t=>this.processResponse(t))}generateUpdatedAtProperty(){return{updatedAt:p(new Date)}}processResponse(e){e&&e.msg?(this.customToastService.add({message:e.msg,type:"success",duration:5e3}),this.triggerStatusChange()):this.customToastService.add({message:e.message,type:"error",duration:5e3}),this.isSendEmailFromDetailComponentSubmitting.set(!1)}createInvoiceFromQuote(e){if(e.status!=="aceptada")return;this.dialog.open(g,{width:"32rem",autoFocus:!1,data:e}).updatePosition({top:"100px"})}removeQuote(e){let t=this.dialog.open(w,{width:"60rem",height:"20rem",autoFocus:!1,data:`Est\xE1s seguro/a de que deseas eliminar esta cotizaci\xF3n ${e.quoteNumber} ?`});t.updatePosition({top:"100px"}),t.afterClosed().subscribe(i=>{i&&this.quoteService.removeOne(e.id,p(new Date)).subscribe(o=>this.processResponse(o))})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=I({token:n,factory:n.\u0275fac,providedIn:"root"})};export{U as a};
