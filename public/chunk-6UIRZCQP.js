import{a as fe}from"./chunk-CIPV7YBS.js";import{a as he}from"./chunk-XACSRI3N.js";import{b as _e,c as Ce}from"./chunk-HXDGC66B.js";import"./chunk-YLYPY7Y2.js";import{a as de,b as ue}from"./chunk-ZQVIZBGI.js";import{a as pe}from"./chunk-KVBJ4PGU.js";import"./chunk-IBKVHNU3.js";import{a as I}from"./chunk-GZHOXXQG.js";import{a as se}from"./chunk-5LJDG4R3.js";import{a as ce}from"./chunk-FUDPSQJN.js";import{a as me}from"./chunk-5TLBDS6K.js";import{a as le}from"./chunk-WKFQL3IM.js";import{b as W,c as f,d as H,e as J,h as K,i as X,k as Y,l as Z,m as ee,n as te,o as ie,p as ne,q as oe,t as re,u as ae}from"./chunk-UP3F5373.js";import{A as z,B as y,C as $,L as j,f as M,i as P,j as R,k as V,p as G,v as L,w as B,z as U}from"./chunk-4ZQGKSBB.js";import{$a as d,Ab as h,Ba as O,C as N,Jb as r,Kb as Q,Lb as F,Ma as l,Sb as g,Ub as E,Wa as k,ba as s,fb as u,fc as x,ia as v,ja as b,kb as p,na as A,nb as q,ob as w,pb as i,qb as t,rb as m,vb as T,wa as C,zb as S}from"./chunk-F6XVVQNR.js";var ve=(a,e)=>e.id,be=(a,e)=>e.code;function xe(a,e){a&1&&(i(0,"small",14),r(1," cliente es requerido "),t())}function ge(a,e){a&1&&(i(0,"small",14),r(1," fecha inicio es requerida "),t())}function Ee(a,e){a&1&&(i(0,"small",14),r(1," item es requerido "),t())}function ye(a,e){a&1&&(i(0,"small",14),r(1," cantidad debe ser > 0 "),t())}function Ie(a,e){a&1&&(i(0,"small",14),r(1," precio incorrecto "),t())}function Qe(a,e){if(a&1&&(i(0,"option",56),r(1),t()),a&2){let n=e.$implicit;u("value",n.id),l(),F(" ",`${n.code} - ${n.name}`," ")}}function Fe(a,e){a&1&&(i(0,"small",14),r(1," contabilidad es requerido "),t())}function qe(a,e){if(a&1&&(i(0,"option",56),r(1),t()),a&2){let n=e.$implicit;u("value",n.code),l(),Q(n.label)}}function we(a,e){a&1&&(i(0,"small",14),r(1," impuesto es requerido "),t())}function Te(a,e){if(a&1){let n=T();i(0,"tr",48)(1,"td")(2,"custom-select",49),S("itemSelectedEmitter",function(c){let _=v(n).index,Se=h(2);return b(Se.onItemSelectedInRow(c,_))}),t(),d(3,Ee,2,0,"small",14),t(),i(4,"td"),m(5,"textarea",50),t(),i(6,"td"),m(7,"input",51),d(8,ye,2,0,"small",14),t(),i(9,"td"),m(10,"input",52),d(11,Ie,2,0,"small",14),t(),i(12,"td"),m(13,"input",53),t(),i(14,"td")(15,"select",54)(16,"option",55),r(17,"--Seleccione--"),t(),q(18,Qe,2,2,"option",56,ve),t(),d(20,Fe,2,0,"small",14),t(),i(21,"td")(22,"select",57),q(23,qe,2,2,"option",56,be),t(),d(25,we,2,0,"small",14),t(),i(26,"td"),m(27,"ng-select",58),t(),i(28,"td")(29,"button",59),S("click",function(){let c=v(n).index,_=h(2);return b(_.removeQuoteItem(c))}),m(30,"i",60),t()()()}if(a&2){let n=e.index,o=h(2);u("formGroupName",n)("id","row_"+n),l(3),p(o.validField("quoteItems."+n+".itemId")?3:-1),l(5),p(o.validField("quoteItems."+n+".quantity")?8:-1),l(3),p(o.validField("quoteItems."+n+".price")?11:-1),l(7),w(o.accounts()),l(2),p(o.validField("quoteItems."+n+".accountId")?20:-1),l(3),w(o.taxRates),l(2),p(o.validField("quoteItems."+n+".taxRate")?25:-1),l(2),u("items",o.sellers())("searchable",!0)}}function De(a,e){a&1&&(i(0,"tr",31)(1,"td",61)(2,"small"),r(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),t()()())}function Ne(a,e){a&1&&(i(0,"div",47),r(1," Editando y enviando "),m(2,"div",62),t())}function Ae(a,e){a&1&&r(0," Editar y enviar ")}function Oe(a,e){if(a&1){let n=T();i(0,"form",7)(1,"div",9)(2,"div",10)(3,"label",11),r(4," Cliente "),i(5,"span",12),r(6,"*"),t()(),m(7,"ng-select",13),d(8,xe,2,0,"small",14),t(),i(9,"div",10)(10,"label",15),r(11," Fecha inicio "),i(12,"span",12),r(13,"*"),t()(),m(14,"input",16),d(15,ge,2,0,"small",14),t(),i(16,"div",10)(17,"label",17),r(18," Fecha expira "),i(19,"span",18),r(20,"opcional"),t()(),i(21,"quick-date-picker",19),S("dateChanged",function(c){v(n);let _=h();return b(_.onExpireDateChange(c))}),t()(),i(22,"div",10)(23,"label",17),r(24," Moneda "),i(25,"span",12),r(26,"*"),t()(),i(27,"select",20)(28,"option",21),r(29,"USD"),t(),i(30,"option",22),r(31,"Colones"),t()()(),i(32,"div",10)(33,"div",23)(34,"label",24),r(35," N\xFAmero cotizaci\xF3n "),t(),i(36,"span"),r(37,"#"),t()(),m(38,"input",25),t()(),i(39,"table",26)(40,"thead")(41,"tr")(42,"th",27)(43,"label"),r(44,"Item"),t()(),i(45,"th",27)(46,"label"),r(47,"Descripci\xF3n"),t()(),i(48,"th",28)(49,"label"),r(50," Cantidad "),t()(),i(51,"th",28)(52,"label"),r(53,"Precio"),t()(),i(54,"th",28)(55,"label"),r(56,"Descuento (%)"),t()(),i(57,"th",28)(58,"label"),r(59,"Cuenta"),t()(),i(60,"th",28)(61,"label"),r(62,"Impuesto"),t()(),i(63,"th",28)(64,"label"),r(65,"Vendedor"),t()(),m(66,"th",28),t()(),i(67,"tbody",29),d(68,Te,31,9,"tr",30)(69,De,4,0,"tr",31),t()(),i(70,"button",32),S("click",function(){v(n);let c=h();return b(c.addQuoteItem())}),m(71,"i",33),r(72," Agregar fila "),t(),i(73,"div",34)(74,"div",35)(75,"ul",36)(76,"li",37)(77,"span"),r(78,"Subtotal"),t(),i(79,"span"),r(80),g(81,"number"),t()(),i(82,"li",37)(83,"span"),r(84,"Descuento total"),t(),i(85,"span",14),r(86),g(87,"number"),t()(),i(88,"li",37)(89,"span"),r(90,"Impuesto total"),t(),i(91,"span"),r(92),g(93,"number"),t()(),m(94,"div",38),i(95,"li",39)(96,"span")(97,"span"),r(98,"Total"),t()(),i(99,"strong"),r(100),g(101,"number"),t()()()()(),i(102,"div",9)(103,"div",40)(104,"label",41),r(105," T\xE9rminos "),i(106,"span",18),r(107,"opcional"),t()(),m(108,"textarea",42),t()(),i(109,"div",43)(110,"submit-button",44),S("btnWasClicked",function(c){v(n);let _=h();return b(_.onCustomSubmitBtnClicked(c))}),t(),i(111,"div",45)(112,"button",46),S("click",function(){v(n);let c=h();return b(c.callToAction(c.formNewQuoteService.editAndSendAction))}),d(113,Ne,3,0,"div",47)(114,Ae,1,0),t()()()()}if(a&2){let n,o=h();u("formGroup",o.editQuoteForm()),l(7),u("items",o.clients())("searchable",!0),l(),p(o.validField("clientId")?8:-1),l(7),p(o.validField("initDate")?15:-1),l(23),u("value",(n=o.quote())==null?null:n.quoteNumber),l(30),u("ngForOf",o.quoteItems.controls),l(),p(o.quoteItems.value.length?-1:69),l(11),Q(E(81,15,o.subtotal(),"1.2-2")),l(6),F(" - ",E(87,18,o.totalDiscount(),"1.2-2")," "),l(6),Q(E(93,21,o.totalTax(),"1.2-2")),l(8),F(" ",E(101,24,o.totalAmount(),"1.2-2")," "),l(10),u("isFormSubmitting",o.isFormSubmitting())("buttonAction",o.formNewQuoteService.editAction),l(3),p(o.formNewQuoteService.isFormNewQuoteAndEmailSubmitting()?113:114)}}function ke(a,e){if(a&1&&m(0,"tracking-entity",8),a&2){let n=h();u("tracking",n.quote().tracking)("entity",n.entityData())}}var D=class a{platformId=s(O);fb=s(re);destroyRef=s(A);activatedRoute=s(G);authService=s(L);accountService=s(B);commonAdminService=s(ce);quoteService=s(j);clientService=s(U);formErrorService=s(me);customToastService=s(le);sellers=C([]);accounts=C([]);entityData=C(null);quoteId=C(null);quote=C(null);formNewQuoteService=s(fe);isFormSubmitting=x(()=>this.formNewQuoteService.isFormSubmitting());taxRates=$;clients=C([]);editQuoteForm=C(null);subtotal=x(()=>this.formNewQuoteService.subtotal());totalDiscount=x(()=>this.formNewQuoteService.totalDiscount());totalTax=x(()=>this.formNewQuoteService.totalTax());totalAmount=x(()=>this.formNewQuoteService.totalAmount());get isBrowser(){return V(this.platformId)}get currentDate(){return y(new Date)}get dateInSevenDay(){let e=new Date,n=new Date(new Date().setDate(e.getDate()+7));return y(n)}constructor(){this.quoteId.set(this.activatedRoute.snapshot.params.id),this.entityData.set({refEntity:"Quote",refEntityId:this.quoteId()})}ngOnInit(){this.fetchAllShortClients(),this.fetchSellers(),this.fetchAccounts(),this.fetchQuoteById()}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(I(this.destroyRef)).subscribe(e=>{e&&e.accounts&&this.accounts.set(e.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(I(this.destroyRef)).subscribe(e=>{e&&this.clients.set(e)})}fetchSellers(){this.authService.fetchAllSellers().subscribe(e=>{e&&e.length&&this.sellers.set(e)})}fetchQuoteById(){this.quoteService.fetchOne(this.quoteId()).pipe(I(this.destroyRef)).subscribe(e=>{e&&e.id&&(this.quote.set(e),this.fillOutQuoteForm())})}fillOutQuoteForm(){let e=this.quote(),n=this.fb.array(e.quoteItems.map(o=>{let c={itemId:o.item.id,sellerUid:o.seller?.uid||null,description:o.description??"",quantity:o.quantity,price:o.price,discount:o.discount??0,accountId:o.account?.id,taxRate:o.taxRate??"08",id:o.id},_=this.createQuoteItemFormGroup();return _.patchValue(c),_}));this.editQuoteForm.set(this.fb.group({client:[e.client,[f.required]],initDate:[y(new Date(e.initDate??new Date)),[f.required]],expireDate:[y(new Date(e.expireDate??new Date)),[]],currency:[e.currency??"USD",[f.required]],terms:[e.terms??"",[]],quoteItems:n})),this.quoteItems.controls.forEach(o=>{this.setupItemGroupValueChangeListener(o)}),this.quoteItems&&this.quoteItems.controls&&this.formNewQuoteService.calculateTotals(this.quoteItems)}validField(e){let n=this.editQuoteForm()?.get(e);return n?n.touched&&n.invalid:!1}onExpireDateChange(e){this.editQuoteForm()?.controls.expireDate.patchValue(e)}get quoteItems(){return this.editQuoteForm()?.get("quoteItems")}createQuoteItemFormGroup(){let e=this.fb.group({id:[null],itemId:[null,[f.required]],sellerUid:[null,[]],description:["",[]],quantity:[1,[f.required,f.min(1)]],price:["",[f.required]],discount:[0,[]],accountId:["",[f.required,f.minLength(1)]],taxRate:["08",[f.required,f.minLength(1)]]});return this.setupItemGroupValueChangeListener(e),e}addQuoteItem(){this.quoteItems.push(this.createQuoteItemFormGroup()),this.formNewQuoteService.calculateTotals(this.quoteItems)}removeQuoteItem(e){this.quoteItems.removeAt(e),this.formNewQuoteService.calculateTotals(this.quoteItems)}setupItemGroupValueChangeListener(e){e.valueChanges.pipe(I(this.destroyRef),N(n=>n.quantity!==null&&n.price!==null&&n.discount!==null)).subscribe(()=>{let n=this.quoteItems;n&&this.formNewQuoteService.calculateTotals(n)})}onItemSelectedInRow(e,n){let o=this.quoteItems.at(n);o&&e&&(o.patchValue({description:this.formNewQuoteService.getCorrectDescriptionFromItemSelectedEmitter(this.quote(),e),price:this.formNewQuoteService.getCorrectPriceFromItemSelectedEmitter(this.quote(),e),accountId:this.formNewQuoteService.getCorrectAccountFromItemSelectedEmitter(this.quote(),e)}),this.formNewQuoteService.calculateTotals(this.quoteItems))}onCustomSubmitBtnClicked(e){this.callToAction(e)}callToAction(e){if(this.formErrorService.throwFormErrors(this.editQuoteForm()),!this.formNewQuoteService.verifyQuoteItems(this.quoteItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.editQuoteForm().controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.editQuoteForm().invalid){this.formErrorService.throwFormErrors(this.editQuoteForm());return}let n=this.editQuoteForm().value;n.updatedAt=z(new Date),e==="edit"&&this.formNewQuoteService.onEditAction(this.quoteId(),n),e==="edit_and_send"&&(this.quote()?.status==="borrador"&&(n.status="enviada"),this.formNewQuoteService.handleCreateOrEditQuoteSendingEmailAsWell(n,this.quoteId()))}comeBackToList(){this.commonAdminService.comeBackToList("/list-quotes")}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=k({type:a,selectors:[["edit-quote"]],decls:11,vars:6,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[3,"tracking","entity"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],["value","CRC"],[1,"d-flex","justify-content-between","align-items-end"],["for","quoteNumber",1,"w_100"],["type","text","disabled","",3,"value"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","quoteItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"col-12"],["for","description"],["formControlName","terms","rows","2",1,"w_100"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Editar","secondaryText","Editando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[1,"input-group","ms-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"d-flex","align-items-center"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["bindLabel","name","bindValue","uid","placeholder","--Seleccione--","formControlName","sellerUid",3,"items","searchable"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"],[1,"spinner","ms-2"]],template:function(n,o){n&1&&(i(0,"div",0),m(1,"breadcrumb",1),i(2,"div",2)(3,"div",3)(4,"h3",4),r(5,"Editar cotizaci\xF3n"),t(),i(6,"h4",5),S("click",function(){return o.comeBackToList()}),m(7,"i",6),r(8," Regresar "),t()(),d(9,Oe,115,27,"form",7),t()(),d(10,ke,1,2,"tracking-entity",8)),n&2&&(l(),u("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado cotizaciones")("secondaryLink","/list-quotes"),l(8),p(o.editQuoteForm()?9:-1),l(),p(o.quote()?10:-1))},dependencies:[R,M,P,_e,ae,K,ne,oe,W,X,ie,H,J,Y,te,Z,ee,ue,de,he,Ce,se,pe],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{D as default};
