import{a as ue}from"./chunk-Y5STTOP3.js";import{b as pe,c as fe,d as _e}from"./chunk-MRMPQ2PL.js";import"./chunk-SQSKTF64.js";import{a as se,b as de}from"./chunk-B7XUX2AB.js";import"./chunk-5RJIBXIL.js";import{a as Q}from"./chunk-KGOR65YN.js";import{a as ce}from"./chunk-B2MQD4SO.js";import{a as me}from"./chunk-SVF2QQ2X.js";import{a as le}from"./chunk-QULINWIQ.js";import{b as W,c as d,d as H,e as J,h as K,i as X,k as Y,l as Z,m as ee,n as te,o as ie,p as ne,q as oe,t as re,u as ae}from"./chunk-UQEQGUXM.js";import{A as $,B as I,C as j,K as z,f as P,i as k,j as R,k as V,p as G,v as B,w as L,z as U}from"./chunk-K4252JJD.js";import{Ba as O,C as T,Ib as o,Jb as F,Kb as w,La as l,Rb as x,Tb as E,Va as M,_a as u,ba as s,eb as _,ec as g,ia as S,ja as v,jb as p,mb as y,na as A,nb as q,ob as n,pb as i,qb as c,ub as D,wa as b,yb as C,zb as h}from"./chunk-QAVPLLNK.js";var Ce=(r,e)=>e.id,Se=(r,e)=>e.code;function ve(r,e){r&1&&(n(0,"small",12),o(1," cliente es requerido "),i())}function be(r,e){r&1&&(n(0,"small",12),o(1," fecha inicio es requerida "),i())}function ge(r,e){r&1&&(n(0,"small",12),o(1," item es requerido "),i())}function xe(r,e){r&1&&(n(0,"small",12),o(1," cantidad debe ser > 0 "),i())}function Ee(r,e){r&1&&(n(0,"small",12),o(1," precio incorrecto "),i())}function Ie(r,e){if(r&1&&(n(0,"option",50),o(1),i()),r&2){let t=e.$implicit;_("value",t.id),l(),w(" ",`${t.code} - ${t.name}`," ")}}function Qe(r,e){r&1&&(n(0,"small",12),o(1," contabilidad es requerido "),i())}function Fe(r,e){if(r&1&&(n(0,"option",50),o(1),i()),r&2){let t=e.$implicit;_("value",t.code),l(),F(t.label)}}function we(r,e){r&1&&(n(0,"small",12),o(1," impuesto es requerido "),i())}function ye(r,e){if(r&1){let t=D();n(0,"tr",42)(1,"td")(2,"custom-select",43),C("itemSelectedEmitter",function(m){let f=S(t).index,he=h(2);return v(he.onItemSelectedInRow(m,f))}),i(),u(3,ge,2,0,"small",12),i(),n(4,"td"),c(5,"textarea",44),i(),n(6,"td"),c(7,"input",45),u(8,xe,2,0,"small",12),i(),n(9,"td"),c(10,"input",46),u(11,Ee,2,0,"small",12),i(),n(12,"td"),c(13,"input",47),i(),n(14,"td")(15,"select",48)(16,"option",49),o(17,"--Seleccione--"),i(),y(18,Ie,2,2,"option",50,Ce),i(),u(20,Qe,2,0,"small",12),i(),n(21,"td")(22,"select",51),y(23,Fe,2,2,"option",50,Se),i(),u(25,we,2,0,"small",12),i(),n(26,"td"),c(27,"ng-select",52),i(),n(28,"td")(29,"button",53),C("click",function(){let m=S(t).index,f=h(2);return v(f.removeQuoteItem(m))}),c(30,"i",54),i()()()}if(r&2){let t=e.index,a=h(2);_("formGroupName",t)("id","row_"+t),l(3),p(a.validField("quoteItems."+t+".itemId")?3:-1),l(5),p(a.validField("quoteItems."+t+".quantity")?8:-1),l(3),p(a.validField("quoteItems."+t+".price")?11:-1),l(7),q(a.accounts()),l(2),p(a.validField("quoteItems."+t+".accountId")?20:-1),l(3),q(a.taxRates),l(2),p(a.validField("quoteItems."+t+".taxRate")?25:-1),l(2),_("items",a.sellers())("searchable",!0)}}function qe(r,e){r&1&&(n(0,"tr",25)(1,"td",55)(2,"small"),o(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),i()()())}function De(r,e){r&1&&(n(0,"div",41),o(1," Editando y enviando "),c(2,"div",56),i())}function Ne(r,e){r&1&&o(0," Editar y enviar ")}function Te(r,e){if(r&1){let t=D();n(0,"form",6)(1,"div",7)(2,"div",8)(3,"label",9),o(4," Cliente "),n(5,"span",10),o(6,"*"),i()(),c(7,"ng-select",11),u(8,ve,2,0,"small",12),i(),n(9,"div",8)(10,"label",13),o(11," Fecha inicio "),n(12,"span",10),o(13,"*"),i()(),c(14,"input",14),u(15,be,2,0,"small",12),i(),n(16,"div",8)(17,"label",15),o(18," Fecha expira "),n(19,"span",16),o(20,"opcional"),i()(),n(21,"quick-date-picker",17),C("dateChanged",function(m){S(t);let f=h();return v(f.onExpireDateChange(m))}),i()(),n(22,"div",8)(23,"label",15),o(24," Moneda "),n(25,"span",10),o(26,"*"),i()(),n(27,"select",18)(28,"option",19),o(29,"USD"),i()()()(),n(30,"table",20)(31,"thead")(32,"tr")(33,"th",21)(34,"label"),o(35,"Item"),i()(),n(36,"th",21)(37,"label"),o(38,"Descripci\xF3n"),i()(),n(39,"th",22)(40,"label"),o(41," Cantidad "),i()(),n(42,"th",22)(43,"label"),o(44,"Precio"),i()(),n(45,"th",22)(46,"label"),o(47,"Descuento (%)"),i()(),n(48,"th",22)(49,"label"),o(50,"Cuenta"),i()(),n(51,"th",22)(52,"label"),o(53,"Impuesto"),i()(),n(54,"th",22)(55,"label"),o(56,"Vendedor"),i()(),c(57,"th",22),i()(),n(58,"tbody",23),u(59,ye,31,9,"tr",24)(60,qe,4,0,"tr",25),i()(),n(61,"button",26),C("click",function(){S(t);let m=h();return v(m.addQuoteItem())}),c(62,"i",27),o(63," Agregar fila "),i(),n(64,"div",28)(65,"div",29)(66,"ul",30)(67,"li",31)(68,"span"),o(69,"Subtotal"),i(),n(70,"span"),o(71),x(72,"number"),i()(),n(73,"li",31)(74,"span"),o(75,"Descuento total"),i(),n(76,"span",12),o(77),x(78,"number"),i()(),n(79,"li",31)(80,"span"),o(81,"Impuesto total"),i(),n(82,"span"),o(83),x(84,"number"),i()(),c(85,"div",32),n(86,"li",33)(87,"span")(88,"span"),o(89,"Total"),i()(),n(90,"strong"),o(91),x(92,"number"),i()()()()(),n(93,"div",7)(94,"div",34)(95,"label",35),o(96," T\xE9rminos "),n(97,"span",16),o(98,"opcional"),i()(),c(99,"textarea",36),i()(),n(100,"div",37)(101,"submit-button",38),C("btnWasClicked",function(m){S(t);let f=h();return v(f.onCustomSubmitBtnClicked(m))}),i(),n(102,"div",39)(103,"button",40),C("click",function(){S(t);let m=h();return v(m.callToAction(m.formNewQuoteService.editAndSendAction))}),u(104,De,3,0,"div",41)(105,Ne,1,0),i()()()()}if(r&2){let t=h();_("formGroup",t.editQuoteForm()),l(7),_("items",t.clients())("searchable",!0),l(),p(t.validField("clientId")?8:-1),l(7),p(t.validField("initDate")?15:-1),l(44),_("ngForOf",t.quoteItems.controls),l(),p(t.quoteItems.value.length?-1:60),l(11),F(E(72,14,t.subtotal(),"1.2-2")),l(6),w(" - ",E(78,17,t.totalDiscount(),"1.2-2")," "),l(6),F(E(84,20,t.totalTax(),"1.2-2")),l(8),w(" ",E(92,23,t.totalAmount(),"1.2-2")," "),l(10),_("isFormSubmitting",t.isFormSubmitting())("buttonAction",t.formNewQuoteService.editAction),l(3),p(t.formNewQuoteService.isFormNewQuoteAndEmailSubmitting()?104:105)}}var N=class r{platformId=s(O);fb=s(re);destroyRef=s(A);activatedRoute=s(G);authService=s(B);accountService=s(L);commonAdminService=s(ce);quoteService=s(z);clientService=s(U);formErrorService=s(me);customToastService=s(le);sellers=b([]);accounts=b([]);quoteId=b(null);quote=b(null);formNewQuoteService=s(ue);isFormSubmitting=g(()=>this.formNewQuoteService.isFormSubmitting());taxRates=j;clients=b([]);editQuoteForm=b(null);subtotal=g(()=>this.formNewQuoteService.subtotal());totalDiscount=g(()=>this.formNewQuoteService.totalDiscount());totalTax=g(()=>this.formNewQuoteService.totalTax());totalAmount=g(()=>this.formNewQuoteService.totalAmount());get isBrowser(){return V(this.platformId)}get currentDate(){return I(new Date)}get dateInSevenDay(){let e=new Date,t=new Date(new Date().setDate(e.getDate()+7));return I(t)}constructor(){this.quoteId.set(this.activatedRoute.snapshot.params.id)}ngOnInit(){this.fetchAllShortClients(),this.fetchSellers(),this.fetchAccounts(),this.fetchQuoteById()}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(Q(this.destroyRef)).subscribe(e=>{e&&e.accounts&&this.accounts.set(e.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(Q(this.destroyRef)).subscribe(e=>{e&&this.clients.set(e)})}fetchSellers(){this.authService.fetchAllSellers().subscribe(e=>{e&&e.length&&this.sellers.set(e)})}fetchQuoteById(){this.quoteService.fetchOne(this.quoteId()).pipe(Q(this.destroyRef)).subscribe(e=>{e&&e.id&&(this.quote.set(e),this.fillOutQuoteForm())})}fillOutQuoteForm(){let e=this.quote(),t=this.fb.array(e.quoteItems.map(a=>{let m={itemId:a.item.id,sellerUid:a.seller?.uid||null,description:a.description??"",quantity:a.quantity,price:a.price,discount:a.discount??0,accountId:a.account?.id,taxRate:a.taxRate??"08",id:a.id},f=this.createQuoteItemFormGroup();return f.patchValue(m),f}));this.editQuoteForm.set(this.fb.group({client:[e.client,[d.required]],initDate:[I(new Date(e.initDate??new Date)),[d.required]],expireDate:[I(new Date(e.expireDate??new Date)),[]],currency:[e.currency??"USD",[d.required]],terms:[e.terms??"",[]],quoteItems:t})),this.quoteItems.controls.forEach(a=>{this.setupItemGroupValueChangeListener(a)}),this.quoteItems&&this.quoteItems.controls&&this.formNewQuoteService.calculateTotals(this.quoteItems)}validField(e){let t=this.editQuoteForm()?.get(e);return t?t.touched&&t.invalid:!1}onExpireDateChange(e){this.editQuoteForm()?.controls.expireDate.patchValue(e)}get quoteItems(){return this.editQuoteForm()?.get("quoteItems")}createQuoteItemFormGroup(){let e=this.fb.group({id:[null],itemId:[null,[d.required]],sellerUid:[null,[]],description:["",[]],quantity:[1,[d.required,d.min(1)]],price:["",[d.required]],discount:[0,[]],accountId:["",[d.required,d.minLength(1)]],taxRate:["08",[d.required,d.minLength(1)]]});return this.setupItemGroupValueChangeListener(e),e}addQuoteItem(){this.quoteItems.push(this.createQuoteItemFormGroup()),this.formNewQuoteService.calculateTotals(this.quoteItems)}removeQuoteItem(e){this.quoteItems.removeAt(e),this.formNewQuoteService.calculateTotals(this.quoteItems)}setupItemGroupValueChangeListener(e){e.valueChanges.pipe(Q(this.destroyRef),T(t=>t.quantity!==null&&t.price!==null&&t.discount!==null)).subscribe(()=>{let t=this.quoteItems;t&&this.formNewQuoteService.calculateTotals(t)})}onItemSelectedInRow(e,t){let a=this.quoteItems.at(t);a&&e&&(a.patchValue({description:this.formNewQuoteService.getCorrectDescriptionFromItemSelectedEmitter(this.quote(),e),price:this.formNewQuoteService.getCorrectPriceFromItemSelectedEmitter(this.quote(),e),accountId:this.formNewQuoteService.getCorrectAccountFromItemSelectedEmitter(this.quote(),e)}),this.formNewQuoteService.calculateTotals(this.quoteItems))}onCustomSubmitBtnClicked(e){this.callToAction(e)}callToAction(e){if(this.formErrorService.throwFormErrors(this.editQuoteForm()),!this.formNewQuoteService.verifyQuoteItems(this.quoteItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.editQuoteForm().controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.editQuoteForm().invalid){this.formErrorService.throwFormErrors(this.editQuoteForm());return}let t=this.editQuoteForm().value;t.updatedAt=$(new Date),e==="edit"&&this.formNewQuoteService.onEditAction(this.quoteId(),t),e==="edit_and_send"&&(this.quote()?.status==="borrador"&&(t.status="enviada"),this.formNewQuoteService.handleCreateOrEditQuoteSendingEmailAsWell(t,this.quoteId()))}comeBackToList(){this.commonAdminService.comeBackToList("/list-quotes")}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=M({type:r,selectors:[["edit-quote"]],decls:9,vars:1,consts:[[1,"main_content"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","quoteItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"col-12"],["for","description"],["formControlName","terms","rows","2",1,"w_100"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Editar","secondaryText","Editando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[1,"input-group","ms-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"d-flex","align-items-center"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["bindLabel","name","bindValue","uid","placeholder","--Seleccione--","formControlName","sellerUid",3,"items","searchable"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"],[1,"spinner","ms-2"]],template:function(t,a){t&1&&(n(0,"div",0)(1,"div",1)(2,"div",2)(3,"h3",3),o(4,"Editar cotizaci\xF3n"),i(),n(5,"h4",4),C("click",function(){return a.comeBackToList()}),c(6,"i",5),o(7," Regresar "),i()(),u(8,Te,106,26,"form",6),i()()),t&2&&(l(8),p(a.editQuoteForm()?8:-1))},dependencies:[R,P,k,pe,ae,K,ne,oe,W,X,ie,H,J,Y,te,Z,ee,de,se,fe,_e],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{N as default};
