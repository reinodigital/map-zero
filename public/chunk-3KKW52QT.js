import{a as ue}from"./chunk-4ZXAGEBE.js";import{b as se,c as de,d as pe}from"./chunk-MRMPQ2PL.js";import{a as ce,b as me}from"./chunk-B7XUX2AB.js";import"./chunk-5RJIBXIL.js";import{a as x}from"./chunk-KGOR65YN.js";import{a as le}from"./chunk-B2MQD4SO.js";import{a as ae}from"./chunk-SVF2QQ2X.js";import{a as re}from"./chunk-QULINWIQ.js";import{b as W,c as m,d as z,e as K,h as Q,i as H,k as J,l as X,m as Y,n as Z,o as ee,p as te,q as ie,t as ne,u as oe}from"./chunk-UQEQGUXM.js";import{A as j,B as T,C as U,f as R,i as G,j as q,k as V,v as B,w as L,z as $}from"./chunk-K4252JJD.js";import{Ba as M,C as A,Ib as o,Jb as C,Kb as b,La as l,Rb as I,Tb as g,Va as P,_a as d,ba as s,eb as u,ec as S,ia as E,ja as w,jb as p,mb as y,na as O,nb as N,ob as t,pb as e,qb as c,ub as k,wa as F,yb as _,zb as h}from"./chunk-QAVPLLNK.js";var fe=(r,i)=>i.id,_e=(r,i)=>i.code;function Se(r,i){r&1&&(t(0,"small",12),o(1," cliente es requerido "),e())}function Ie(r,i){r&1&&(t(0,"small",12),o(1," fecha inicio es requerida "),e())}function ge(r,i){r&1&&(t(0,"small",12),o(1," item es requerido "),e())}function he(r,i){r&1&&(t(0,"small",12),o(1," cantidad debe ser > 0 "),e())}function Ce(r,i){r&1&&(t(0,"small",12),o(1," precio incorrecto "),e())}function be(r,i){if(r&1&&(t(0,"option",49),o(1),e()),r&2){let n=i.$implicit;u("value",n.id),l(),b(" ",`${n.code} - ${n.name}`," ")}}function xe(r,i){r&1&&(t(0,"small",12),o(1," contabilidad es requerido "),e())}function Ee(r,i){if(r&1&&(t(0,"option",49),o(1),e()),r&2){let n=i.$implicit;u("value",n.code),l(),C(n.label)}}function we(r,i){r&1&&(t(0,"small",12),o(1," impuesto es requerido "),e())}function Fe(r,i){if(r&1){let n=k();t(0,"tr",41)(1,"td")(2,"custom-select",42),_("itemSelectedEmitter",function(v){let f=E(n).index,ve=h();return w(ve.onItemSelectedInRow(v,f))}),e(),d(3,ge,2,0,"small",12),e(),t(4,"td"),c(5,"textarea",43),e(),t(6,"td"),c(7,"input",44),d(8,he,2,0,"small",12),e(),t(9,"td"),c(10,"input",45),d(11,Ce,2,0,"small",12),e(),t(12,"td"),c(13,"input",46),e(),t(14,"td")(15,"select",47)(16,"option",48),o(17,"--Seleccione--"),e(),y(18,be,2,2,"option",49,fe),e(),d(20,xe,2,0,"small",12),e(),t(21,"td")(22,"select",50),y(23,Ee,2,2,"option",49,_e),e(),d(25,we,2,0,"small",12),e(),t(26,"td")(27,"button",51),_("click",function(){let v=E(n).index,f=h();return w(f.removeInvoiceItem(v))}),c(28,"i",52),e()()()}if(r&2){let n=i.index,a=h();u("formGroupName",n)("id","row_"+n),l(3),p(a.validField("invoiceItems."+n+".itemId")?3:-1),l(5),p(a.validField("invoiceItems."+n+".quantity")?8:-1),l(3),p(a.validField("invoiceItems."+n+".price")?11:-1),l(7),N(a.accounts()),l(2),p(a.validField("invoiceItems."+n+".accountId")?20:-1),l(3),N(a.taxRates),l(2),p(a.validField("invoiceItems."+n+".taxRate")?25:-1)}}function ye(r,i){r&1&&(t(0,"tr",30)(1,"td",53)(2,"small"),o(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),e()()())}var D=class r{platformId=s(M);fb=s(ne);destroyRef=s(O);authService=s(B);accountService=s(L);commonAdminService=s(le);clientService=s($);formErrorService=s(ae);customToastService=s(re);accounts=F([]);formInvoiceService=s(ue);isFormSubmitting=S(()=>this.formInvoiceService.isFormSubmitting());taxRates=U;clients=F([]);newInvoiceForm=this.fb.group({client:[null,[m.required]],initDate:[this.currentDate,[m.required]],expireDate:[this.dateInSevenDay,[]],currency:["USD",[m.required]],reference:["",[]],invoiceItems:this.fb.array([this.createInvoiceItemFormGroup(),this.createInvoiceItemFormGroup()])});subtotal=S(()=>this.formInvoiceService.subtotal());totalDiscount=S(()=>this.formInvoiceService.totalDiscount());totalTax=S(()=>this.formInvoiceService.totalTax());totalAmount=S(()=>this.formInvoiceService.totalAmount());get isBrowser(){return V(this.platformId)}get currentDate(){return T(new Date)}get dateInSevenDay(){let i=new Date,n=new Date(new Date().setDate(i.getDate()+7));return T(n)}ngOnInit(){this.formInvoiceService.cleanTotalValues(),this.fetchAllShortClients(),this.fetchAccounts(),this.invoiceItems.controls.forEach(i=>{this.setupItemGroupValueChangeListener(i)})}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(x(this.destroyRef)).subscribe(i=>{i&&i.accounts&&this.accounts.set(i.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(x(this.destroyRef)).subscribe(i=>{i&&this.clients.set(i)})}validField(i){let n=this.newInvoiceForm.get(i);return n?n.touched&&n.invalid:!1}onExpireDateChange(i){this.newInvoiceForm.controls.expireDate.patchValue(i)}get invoiceItems(){return this.newInvoiceForm.get("invoiceItems")}createInvoiceItemFormGroup(){let i=this.fb.group({itemId:[null,[m.required]],description:["",[]],quantity:[1,[m.required,m.min(1)]],price:["",[m.required]],discount:[0,[]],accountId:["",[m.required,m.minLength(1)]],taxRate:["08",[m.required,,m.minLength(1)]]});return this.setupItemGroupValueChangeListener(i),i}addInvoiceItem(){this.invoiceItems.push(this.createInvoiceItemFormGroup()),this.formInvoiceService.calculateTotals(this.invoiceItems)}removeInvoiceItem(i){this.invoiceItems.removeAt(i),this.formInvoiceService.calculateTotals(this.invoiceItems)}setupItemGroupValueChangeListener(i){i.valueChanges.pipe(x(this.destroyRef),A(n=>n.quantity!==null&&n.price!==null&&n.discount!==null)).subscribe(()=>{this.formInvoiceService.calculateTotals(this.invoiceItems)})}onItemSelectedInRow(i,n){let a=this.invoiceItems.at(n);a&&i&&(a.patchValue({description:i.description||"",price:i.salePrice??0,accountId:i.saleAccountId??""}),this.formInvoiceService.calculateTotals(this.invoiceItems))}onCustomSubmitBtnClicked(i){this.callToAction(i)}callToAction(i){if(this.formErrorService.throwFormErrors(this.newInvoiceForm),!this.formInvoiceService.verifyInvoiceItems(this.invoiceItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.newInvoiceForm.controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.newInvoiceForm.invalid)return;let n=this.newInvoiceForm.value;switch(n.createdAt=j(new Date),i){case"save":n.status="borrador",n.action="save",this.formInvoiceService.onSaveAction(n);break;case"mark_as_sent":n.status="enviada",n.action="mark_as_sent",this.formInvoiceService.onSaveAction(n);break;case"send":n.status="borrador",n.action="send",this.formInvoiceService.handleCreateOrEditInvoiceSendingEmailAsWell(n);break;default:break}}comeBackToList(){this.commonAdminService.comeBackToList("/list-invoices")}static \u0275fac=function(n){return new(n||r)};static \u0275cmp=P({type:r,selectors:[["new-invoice"]],decls:108,vars:25,consts:[[1,"main_content"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["for","currency",1,"w_100"],["formControlName","currency"],["value","USD"],[1,"d-flex","justify-content-between","align-items-end","mb-1"],["for","reference",1,"w_100"],[1,"fas","fa-tag"],["type","text","formControlName","reference"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","invoiceItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Guardar","secondaryText","Guardando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"]],template:function(n,a){n&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"h3",3),o(4,"Nueva factura"),e(),t(5,"h4",4),_("click",function(){return a.comeBackToList()}),c(6,"i",5),o(7," Regresar "),e()(),t(8,"form",6)(9,"div",7)(10,"div",8)(11,"label",9),o(12," Cliente "),t(13,"span",10),o(14,"*"),e()(),c(15,"ng-select",11),d(16,Se,2,0,"small",12),e(),t(17,"div",8)(18,"label",13),o(19," Fecha inicio "),t(20,"span",10),o(21,"*"),e()(),c(22,"input",14),d(23,Ie,2,0,"small",12),e(),t(24,"div",8)(25,"label",15),o(26," Fecha expira "),t(27,"span",16),o(28,"opcional"),e()(),t(29,"quick-date-picker",17),_("dateChanged",function(f){return a.onExpireDateChange(f)}),e()(),t(30,"div",8)(31,"label",18),o(32," Moneda "),t(33,"span",10),o(34,"*"),e()(),t(35,"select",19)(36,"option",20),o(37,"USD"),e()()(),t(38,"div",8)(39,"div",21)(40,"label",22),o(41," Referencia "),t(42,"span",16),o(43,"opcional"),e()(),c(44,"i",23),e(),c(45,"input",24),e()(),t(46,"table",25)(47,"thead")(48,"tr")(49,"th",26)(50,"label"),o(51,"Item"),e()(),t(52,"th",26)(53,"label"),o(54,"Descripci\xF3n"),e()(),t(55,"th",27)(56,"label"),o(57," Cantidad "),e()(),t(58,"th",27)(59,"label"),o(60,"Precio"),e()(),t(61,"th",27)(62,"label"),o(63,"Descuento (%)"),e()(),t(64,"th",27)(65,"label"),o(66,"Cuenta"),e()(),t(67,"th",27)(68,"label"),o(69,"Impuesto"),e()(),c(70,"th",27),e()(),t(71,"tbody",28),d(72,Fe,29,7,"tr",29)(73,ye,4,0,"tr",30),e()(),t(74,"button",31),_("click",function(){return a.addInvoiceItem()}),c(75,"i",32),o(76," Agregar fila "),e(),t(77,"div",33)(78,"div",34)(79,"ul",35)(80,"li",36)(81,"span"),o(82,"Subtotal"),e(),t(83,"span"),o(84),I(85,"number"),e()(),t(86,"li",36)(87,"span"),o(88,"Descuento total"),e(),t(89,"span",12),o(90),I(91,"number"),e()(),t(92,"li",36)(93,"span"),o(94,"Impuesto total"),e(),t(95,"span"),o(96),I(97,"number"),e()(),c(98,"div",37),t(99,"li",38)(100,"span")(101,"span"),o(102,"Total"),e()(),t(103,"strong"),o(104),I(105,"number"),e()()()()(),t(106,"div",39)(107,"submit-button",40),_("btnWasClicked",function(f){return a.onCustomSubmitBtnClicked(f)}),e()()()()()),n&2&&(l(8),u("formGroup",a.newInvoiceForm),l(7),u("items",a.clients())("searchable",!0),l(),p(a.validField("clientId")?16:-1),l(7),p(a.validField("initDate")?23:-1),l(49),u("ngForOf",a.invoiceItems.controls),l(),p(a.invoiceItems.value.length?-1:73),l(11),C(g(85,13,a.subtotal(),"1.2-2")),l(6),b(" - ",g(91,16,a.totalDiscount(),"1.2-2")," "),l(6),C(g(97,19,a.totalTax(),"1.2-2")),l(8),b(" ",g(105,22,a.totalAmount(),"1.2-2")," "),l(3),u("isFormSubmitting",a.isFormSubmitting())("buttonAction",a.formInvoiceService.saveAction))},dependencies:[q,R,G,se,oe,Q,te,ie,W,H,ee,z,K,J,Z,X,Y,me,ce,de,pe],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{D as default};
