import{a}from"./chunk-2KGG56MP.js";import{a as f}from"./chunk-6EZQCGFF.js";import{w as T}from"./chunk-HZJ2PVQJ.js";import{a as h}from"./chunk-WKFQL3IM.js";import{D as I,L as E,r as v}from"./chunk-G6MTQLVM.js";import{X as b,ba as d,wa as r}from"./chunk-F6XVVQNR.js";var Q=class l{router=d(v);dialog=d(T);customToastService=d(h);quoteService=d(E);isFormSubmitting=r(!1);isFormNewQuoteAndEmailSubmitting=r(!1);saveAction="save";sendAction="send";markAsSentAction="mark_as_sent";editAction="edit";editAndSendAction="edit_and_send";subtotal=r(0);totalDiscount=r(0);totalTax=r(0);totalAmount=r(0);cleanTotalValues(){this.subtotal.set(0),this.totalDiscount.set(0),this.totalTax.set(0),this.totalAmount.set(0)}calculateTotals(e){let t=e.controls.reduce((u,s)=>{let m=s.get("quantity")?.value||0,c=s.get("price")?.value||0;return u+m*a(c)},0),i=e.controls.reduce((u,s)=>{let m=s.get("quantity")?.value||0,c=s.get("price")?.value||0,g=a(c),S=s.get("discount")?.value||0,p=m*g*S/100;return u+p},0),o=a(t)-a(i),n=0;e.controls.forEach(u=>{let s=u.get("quantity")?.value||0,m=u.get("price")?.value||0,c=a(m),g=u.get("discount")?.value||0,S=s*c*g/100,p=u.get("taxRate")?.value||"08",A=s*c-S;n+=A*I(p)/100}),this.subtotal.set(a(t)),this.totalDiscount.set(a(i)),this.totalTax.set(a(n)),this.totalAmount.set(a(o+n))}verifyQuoteItems(e){return e.controls.every(t=>this.isQuoteItemValid(t))}isQuoteItemValid(e){let t=e.get("quantity")?.value,i=e.get("price")?.value,o=e.get("itemId")?.value;return t>=1&&i>0&&!!o}onSaveAction(e){this.isFormSubmitting.set(!0),this.quoteService.create(e).subscribe(t=>{t&&t.id?(this.customToastService.add({message:`Cotizaci\xF3n generada con estado ${t.status} correctamente.`,type:"success",duration:5e3}),this.router.navigateByUrl(`/detail-quote/${t.id}`)):this.customToastService.add({message:t.message,type:"error",duration:5e3}),this.isFormSubmitting.set(!1)})}onEditAction(e,t){this.isFormSubmitting.set(!0),this.quoteService.update(e,t).subscribe(i=>{i&&i.id?(this.customToastService.add({message:"Cotizaci\xF3n actualizada correctamente.",type:"success",duration:5e3}),this.router.navigateByUrl(`/detail-quote/${i.id}`)):this.customToastService.add({message:i.message,type:"error",duration:5e3}),this.isFormSubmitting.set(!1)})}handleCreateOrEditQuoteSendingEmailAsWell(e,t=null){let i={clientName:e.client.name,currency:e.currency,terms:e.terms,total:this.totalAmount()},o=this.dialog.open(f,{width:"70rem",autoFocus:!1,data:i});o.updatePosition({top:"100px"}),o.afterClosed().subscribe(n=>{n&&(t?this.onEditQuoteSendingEmail(t,e,JSON.parse(n)):this.onCreateNewQuoteSendingEmail(e,JSON.parse(n)))})}onCreateNewQuoteSendingEmail(e,t){this.quoteService.create(e).subscribe(i=>{i&&i.id?(this.customToastService.add({message:`Cotizaci\xF3n generada con estado ${e.status} correctamente.`,type:"success",duration:8e3}),this.sendQuoteEmail(i.id,t)):this.customToastService.add({message:i.message,type:"error",duration:8e3})})}onEditQuoteSendingEmail(e,t,i){this.quoteService.update(e,t).subscribe(o=>{o&&o.id?(this.customToastService.add({message:"Cotizaci\xF3n actualizada correctamente.",type:"success",duration:8e3}),this.sendQuoteEmail(o.id,i)):this.customToastService.add({message:o.message,type:"error",duration:8e3})})}sendQuoteEmail(e,t){this.isFormNewQuoteAndEmailSubmitting.set(!0),this.quoteService.sendEmail(e,t).subscribe(i=>{i&&i.msg?this.customToastService.add({message:i.msg,type:"success",duration:5e3}):this.customToastService.add({message:i.message,type:"error",duration:5e3}),this.isFormNewQuoteAndEmailSubmitting.set(!1),this.router.navigateByUrl("/detail-quote/"+e)})}getCorrectPriceFromItemSelectedEmitter(e,t){let i=e?.quoteItems.find(o=>o.item.id===t.id);return t.isLoadingExistingItem?i?.price??0:t.salePrice}getCorrectAccountFromItemSelectedEmitter(e,t){let i=e?.quoteItems.find(o=>o.item.id===t.id);return t.isLoadingExistingItem?i?.account?.id??"":t.saleAccountId??""}getCorrectDescriptionFromItemSelectedEmitter(e,t){let i=e?.quoteItems.find(o=>o.item.id===t.id);return t.isLoadingExistingItem?i?.description??"":t.description??""}static \u0275fac=function(t){return new(t||l)};static \u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"})};export{Q as a};
