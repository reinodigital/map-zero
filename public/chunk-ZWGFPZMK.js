import{a as ue}from"./chunk-NPH5TFSH.js";import{b as de,c as pe,d as fe}from"./chunk-NXWWDWK6.js";import"./chunk-MVS4OKEI.js";import{a as me}from"./chunk-OS3EXCMQ.js";import{a as ce,b as se}from"./chunk-RZK5OI6K.js";import"./chunk-VC644A6X.js";import{a as E}from"./chunk-KGOR65YN.js";import{a as le}from"./chunk-NEVGVLEA.js";import{a as ae}from"./chunk-U4TVSC3Q.js";import{a as re}from"./chunk-QULINWIQ.js";import{b as z,c,d as j,e as W,h as K,i as H,k as J,l as X,m as Y,n as Z,o as ee,p as te,q as ie,t as ne,u as oe}from"./chunk-SRQMAJVA.js";import{A as U,B as T,C as $,f as O,i as P,j as R,k as G,v as V,w as L,z as B}from"./chunk-7OFENO7U.js";import{Ba as k,C as A,Ib as n,Jb as w,Kb as x,La as l,Rb as h,Tb as b,Va as q,_a as d,ba as s,eb as p,ec as v,ia as N,ja as Q,jb as f,mb as y,na as D,nb as I,ob as t,pb as e,qb as m,ub as M,wa as g,yb as _,zb as C}from"./chunk-QAVPLLNK.js";var Se=(a,i)=>i.id,ve=(a,i)=>i.code;function he(a,i){a&1&&(t(0,"small",13),n(1," cliente es requerido "),e())}function be(a,i){a&1&&(t(0,"small",13),n(1," fecha inicio es requerida "),e())}function ge(a,i){a&1&&(t(0,"small",13),n(1," item es requerido "),e())}function Ce(a,i){a&1&&(t(0,"small",13),n(1," cantidad debe ser > 0 "),e())}function we(a,i){a&1&&(t(0,"small",13),n(1," precio incorrecto "),e())}function xe(a,i){if(a&1&&(t(0,"option",55),n(1),e()),a&2){let o=i.$implicit;p("value",o.id),l(),x(" ",`${o.code} - ${o.name}`," ")}}function Ee(a,i){a&1&&(t(0,"small",13),n(1," contabilidad es requerido "),e())}function Ne(a,i){if(a&1&&(t(0,"option",55),n(1),e()),a&2){let o=i.$implicit;p("value",o.code),l(),w(o.label)}}function Qe(a,i){a&1&&(t(0,"small",13),n(1," impuesto es requerido "),e())}function ye(a,i){if(a&1){let o=M();t(0,"tr",47)(1,"td")(2,"custom-select",48),_("itemSelectedEmitter",function(u){let S=N(o).index,_e=C();return Q(_e.onItemSelectedInRow(u,S))}),e(),d(3,ge,2,0,"small",13),e(),t(4,"td"),m(5,"textarea",49),e(),t(6,"td"),m(7,"input",50),d(8,Ce,2,0,"small",13),e(),t(9,"td"),m(10,"input",51),d(11,we,2,0,"small",13),e(),t(12,"td"),m(13,"input",52),e(),t(14,"td")(15,"select",53)(16,"option",54),n(17,"--Seleccione--"),e(),y(18,xe,2,2,"option",55,Se),e(),d(20,Ee,2,0,"small",13),e(),t(21,"td")(22,"select",56),y(23,Ne,2,2,"option",55,ve),e(),d(25,Qe,2,0,"small",13),e(),t(26,"td"),m(27,"ng-select",57),e(),t(28,"td")(29,"button",58),_("click",function(){let u=N(o).index,S=C();return Q(S.removeQuoteItem(u))}),m(30,"i",59),e()()()}if(a&2){let o=i.index,r=C();p("formGroupName",o)("id","row_"+o),l(3),f(r.validField("quoteItems."+o+".itemId")?3:-1),l(5),f(r.validField("quoteItems."+o+".quantity")?8:-1),l(3),f(r.validField("quoteItems."+o+".price")?11:-1),l(7),I(r.accounts()),l(2),f(r.validField("quoteItems."+o+".accountId")?20:-1),l(3),I(r.taxRates),l(2),f(r.validField("quoteItems."+o+".taxRate")?25:-1),l(2),p("items",r.sellers())("searchable",!0)}}function Ie(a,i){a&1&&(t(0,"tr",26)(1,"td",60)(2,"small"),n(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),e()()())}function Te(a,i){a&1&&(t(0,"div",42),n(1," Enviando "),m(2,"div",61),e())}function Fe(a,i){a&1&&n(0," Enviar ")}var F=class a{platformId=s(k);fb=s(ne);destroyRef=s(D);authService=s(V);accountService=s(L);commonAdminService=s(le);clientService=s(B);formErrorService=s(ae);customToastService=s(re);sellers=g([]);accounts=g([]);formNewQuoteService=s(ue);isFormSubmitting=v(()=>this.formNewQuoteService.isFormSubmitting());taxRates=$;clients=g([]);newQuoteForm=this.fb.group({client:[null,[c.required]],initDate:[this.currentDate,[c.required]],expireDate:[this.dateInSevenDay,[]],currency:["USD",[c.required]],terms:["",[]],quoteItems:this.fb.array([this.createQuoteItemFormGroup(),this.createQuoteItemFormGroup()])});subtotal=v(()=>this.formNewQuoteService.subtotal());totalDiscount=v(()=>this.formNewQuoteService.totalDiscount());totalTax=v(()=>this.formNewQuoteService.totalTax());totalAmount=v(()=>this.formNewQuoteService.totalAmount());get isBrowser(){return G(this.platformId)}get currentDate(){return T(new Date)}get dateInSevenDay(){let i=new Date,o=new Date(new Date().setDate(i.getDate()+7));return T(o)}ngOnInit(){this.formNewQuoteService.cleanTotalValues(),this.fetchAllShortClients(),this.fetchSellers(),this.fetchAccounts(),this.quoteItems.controls.forEach(i=>{this.setupItemGroupValueChangeListener(i)})}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(E(this.destroyRef)).subscribe(i=>{i&&i.accounts&&this.accounts.set(i.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(E(this.destroyRef)).subscribe(i=>{i&&this.clients.set(i)})}fetchSellers(){this.authService.fetchAllSellers().subscribe(i=>{i&&i.length&&this.sellers.set(i)})}validField(i){let o=this.newQuoteForm.get(i);return o?o.touched&&o.invalid:!1}onExpireDateChange(i){this.newQuoteForm.controls.expireDate.patchValue(i)}get quoteItems(){return this.newQuoteForm.get("quoteItems")}createQuoteItemFormGroup(){let i=this.fb.group({itemId:[null,[c.required]],sellerUid:[null,[]],description:["",[]],quantity:[1,[c.required,c.min(1)]],price:["",[c.required]],discount:[0,[]],accountId:["",[c.required,c.minLength(1)]],taxRate:["08",[c.required,,c.minLength(1)]]});return this.setupItemGroupValueChangeListener(i),i}addQuoteItem(){this.quoteItems.push(this.createQuoteItemFormGroup()),this.formNewQuoteService.calculateTotals(this.quoteItems)}removeQuoteItem(i){this.quoteItems.removeAt(i),this.formNewQuoteService.calculateTotals(this.quoteItems)}setupItemGroupValueChangeListener(i){i.valueChanges.pipe(E(this.destroyRef),A(o=>o.quantity!==null&&o.price!==null&&o.discount!==null)).subscribe(()=>{this.formNewQuoteService.calculateTotals(this.quoteItems)})}onItemSelectedInRow(i,o){let r=this.quoteItems.at(o);r&&i&&(r.patchValue({description:i.description||"",price:i.salePrice??0,accountId:i.saleAccountId??""}),this.formNewQuoteService.calculateTotals(this.quoteItems))}onCustomSubmitBtnClicked(i){this.callToAction(i)}callToAction(i){if(this.formErrorService.throwFormErrors(this.newQuoteForm),!this.formNewQuoteService.verifyQuoteItems(this.quoteItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.newQuoteForm.controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.newQuoteForm.invalid){this.formErrorService.throwFormErrors(this.newQuoteForm);return}let o=this.newQuoteForm.value;switch(o.createdAt=U(new Date),i){case"save":o.status="borrador",o.action="save",this.formNewQuoteService.onSaveAction(o);break;case"mark_as_sent":o.status="enviada",o.action="mark_as_sent",this.formNewQuoteService.onSaveAction(o);break;case"send":o.status="borrador",o.action="send",this.formNewQuoteService.handleCreateOrEditQuoteSendingEmailAsWell(o);break;default:break}}comeBackToList(){this.commonAdminService.comeBackToList("/list-quotes")}static \u0275fac=function(o){return new(o||a)};static \u0275cmp=q({type:a,selectors:[["new-quote"]],decls:125,vars:30,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","quoteItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"col-12"],["for","description"],["formControlName","terms","rows","2",1,"w_100"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Guardar","secondaryText","Guardando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[1,"input-group","ms-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"d-flex","align-items-center"],["type","button","data-bs-toggle","dropdown","aria-expanded","false",1,"btn","btn-outline-secondary","dropdown-toggle","dropdown-toggle-split"],[1,"visually-hidden"],[1,"dropdown-menu"],[1,"dropdown-item","cp",3,"click"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["bindLabel","name","bindValue","uid","placeholder","--Seleccione--","formControlName","sellerUid",3,"items","searchable"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"],[1,"spinner","ms-2"]],template:function(o,r){o&1&&(t(0,"div",0),m(1,"breadcrumb",1),t(2,"div",2)(3,"div",3)(4,"h3",4),n(5,"Nueva cotizaci\xF3n"),e(),t(6,"h4",5),_("click",function(){return r.comeBackToList()}),m(7,"i",6),n(8," Regresar "),e()(),t(9,"form",7)(10,"div",8)(11,"div",9)(12,"label",10),n(13," Cliente "),t(14,"span",11),n(15,"*"),e()(),m(16,"ng-select",12),d(17,he,2,0,"small",13),e(),t(18,"div",9)(19,"label",14),n(20," Fecha inicio "),t(21,"span",11),n(22,"*"),e()(),m(23,"input",15),d(24,be,2,0,"small",13),e(),t(25,"div",9)(26,"label",16),n(27," Fecha expira "),t(28,"span",17),n(29,"opcional"),e()(),t(30,"quick-date-picker",18),_("dateChanged",function(S){return r.onExpireDateChange(S)}),e()(),t(31,"div",9)(32,"label",16),n(33," Moneda "),t(34,"span",11),n(35,"*"),e()(),t(36,"select",19)(37,"option",20),n(38,"USD"),e()()()(),t(39,"table",21)(40,"thead")(41,"tr")(42,"th",22)(43,"label"),n(44,"Item"),e()(),t(45,"th",22)(46,"label"),n(47,"Descripci\xF3n"),e()(),t(48,"th",23)(49,"label"),n(50," Cantidad "),e()(),t(51,"th",23)(52,"label"),n(53,"Precio"),e()(),t(54,"th",23)(55,"label"),n(56,"Descuento (%)"),e()(),t(57,"th",23)(58,"label"),n(59,"Cuenta"),e()(),t(60,"th",23)(61,"label"),n(62,"Impuesto"),e()(),t(63,"th",23)(64,"label"),n(65,"Vendedor"),e()(),m(66,"th",23),e()(),t(67,"tbody",24),d(68,ye,31,9,"tr",25)(69,Ie,4,0,"tr",26),e()(),t(70,"button",27),_("click",function(){return r.addQuoteItem()}),m(71,"i",28),n(72," Agregar fila "),e(),t(73,"div",29)(74,"div",30)(75,"ul",31)(76,"li",32)(77,"span"),n(78,"Subtotal"),e(),t(79,"span"),n(80),h(81,"number"),e()(),t(82,"li",32)(83,"span"),n(84,"Descuento total"),e(),t(85,"span",13),n(86),h(87,"number"),e()(),t(88,"li",32)(89,"span"),n(90,"Impuesto total"),e(),t(91,"span"),n(92),h(93,"number"),e()(),m(94,"div",33),t(95,"li",34)(96,"span")(97,"span"),n(98,"Total"),e()(),t(99,"strong"),n(100),h(101,"number"),e()()()()(),t(102,"div",8)(103,"div",35)(104,"label",36),n(105," T\xE9rminos "),t(106,"span",17),n(107,"opcional"),e()(),m(108,"textarea",37),e()(),t(109,"div",38)(110,"submit-button",39),_("btnWasClicked",function(S){return r.onCustomSubmitBtnClicked(S)}),e(),t(111,"div",40)(112,"button",41),_("click",function(){return r.callToAction(r.formNewQuoteService.sendAction)}),d(113,Te,3,0,"div",42)(114,Fe,1,0),e(),t(115,"button",43)(116,"span",44),n(117,"Toggle Dropdown"),e()(),t(118,"ul",45)(119,"li")(120,"a",46),_("click",function(){return r.callToAction(r.formNewQuoteService.sendAction)}),n(121," Enviar "),e()(),t(122,"li")(123,"a",46),_("click",function(){return r.callToAction(r.formNewQuoteService.markAsSentAction)}),n(124," Marcar como enviada "),e()()()()()()()()),o&2&&(l(),p("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado cotizaciones")("secondaryLink","/list-quotes"),l(8),p("formGroup",r.newQuoteForm),l(7),p("items",r.clients())("searchable",!0),l(),f(r.validField("clientId")?17:-1),l(7),f(r.validField("initDate")?24:-1),l(44),p("ngForOf",r.quoteItems.controls),l(),f(r.quoteItems.value.length?-1:69),l(11),w(b(81,18,r.subtotal(),"1.2-2")),l(6),x(" - ",b(87,21,r.totalDiscount(),"1.2-2")," "),l(6),w(b(93,24,r.totalTax(),"1.2-2")),l(8),x(" ",b(101,27,r.totalAmount(),"1.2-2")," "),l(10),p("isFormSubmitting",r.isFormSubmitting())("buttonAction",r.formNewQuoteService.saveAction),l(3),f(r.formNewQuoteService.isFormNewQuoteAndEmailSubmitting()?113:114))},dependencies:[R,O,P,de,oe,K,te,ie,z,H,ee,j,W,J,Z,X,Y,se,ce,pe,fe,me],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{F as default};
