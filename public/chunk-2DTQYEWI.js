import{a as ue}from"./chunk-BZ2FS2XA.js";import{a as de}from"./chunk-EMREBEI2.js";import{b as se,c as pe}from"./chunk-OZFJSFYS.js";import{a as le,b as me}from"./chunk-KRH6V4OX.js";import"./chunk-G7SYGITX.js";import{a as h}from"./chunk-QVQJSET7.js";import{a as ce}from"./chunk-T5DHTF52.js";import{a as ae}from"./chunk-P3VFXC3H.js";import{a as re}from"./chunk-3L4S2P7E.js";import{a as oe}from"./chunk-IETRKHQE.js";import{b as U,c as m,d as W,e as z,h as K,i as Q,k as H,l as J,m as X,n as Y,o as Z,p as ee,q as te,t as ie,u as ne}from"./chunk-XXXEA7T5.js";import{i as L,l as B,m as $,n as N,o as j}from"./chunk-NXK32U4M.js";import{i as R,m as G,n as V,q}from"./chunk-SF27WFEL.js";import{$a as p,Ab as C,Ba as M,C as D,Jb as o,Kb as x,Lb as E,Ma as c,Tb as I,Vb as b,Wa as k,ba as s,fb as d,gc as S,ia as y,ja as w,kb as u,na as O,nb as F,ob as A,pb as i,qb as e,rb as l,vb as P,wa as g,zb as _}from"./chunk-BXSYLYWC.js";var fe=(a,t)=>t.id,_e=(a,t)=>t.code;function Se(a,t){a&1&&(i(0,"small",13),o(1," cliente es requerido "),e())}function he(a,t){a&1&&(i(0,"small",13),o(1," fecha inicio es requerida "),e())}function Ie(a,t){a&1&&(i(0,"small",13),o(1," item es requerido "),e())}function be(a,t){a&1&&(i(0,"small",13),o(1," cantidad debe ser > 0 "),e())}function ge(a,t){a&1&&(i(0,"small",13),o(1," precio incorrecto "),e())}function Ce(a,t){if(a&1&&(i(0,"option",52),o(1),e()),a&2){let n=t.$implicit;d("value",n.id),c(),E(" ",`${n.code} - ${n.name}`," ")}}function xe(a,t){a&1&&(i(0,"small",13),o(1," contabilidad es requerido "),e())}function Ee(a,t){if(a&1&&(i(0,"option",52),o(1),e()),a&2){let n=t.$implicit;d("value",n.code),c(),x(n.label)}}function ye(a,t){a&1&&(i(0,"small",13),o(1," impuesto es requerido "),e())}function we(a,t){if(a&1){let n=P();i(0,"tr",44)(1,"td")(2,"custom-select",45),_("itemSelectedEmitter",function(v){let f=y(n).index,ve=C();return w(ve.onItemSelectedInRow(v,f))}),e(),p(3,Ie,2,0,"small",13),e(),i(4,"td"),l(5,"textarea",46),e(),i(6,"td"),l(7,"input",47),p(8,be,2,0,"small",13),e(),i(9,"td"),l(10,"input",48),p(11,ge,2,0,"small",13),e(),i(12,"td"),l(13,"input",49),e(),i(14,"td")(15,"select",50)(16,"option",51),o(17,"--Seleccione--"),e(),F(18,Ce,2,2,"option",52,fe),e(),p(20,xe,2,0,"small",13),e(),i(21,"td")(22,"select",53),F(23,Ee,2,2,"option",52,_e),e(),p(25,ye,2,0,"small",13),e(),i(26,"td")(27,"button",54),_("click",function(){let v=y(n).index,f=C();return w(f.removeInvoiceItem(v))}),l(28,"i",55),e()()()}if(a&2){let n=t.index,r=C();d("formGroupName",n)("id","row_"+n),c(3),u(r.validField("invoiceItems."+n+".itemId")?3:-1),c(5),u(r.validField("invoiceItems."+n+".quantity")?8:-1),c(3),u(r.validField("invoiceItems."+n+".price")?11:-1),c(7),A(r.accounts()),c(2),u(r.validField("invoiceItems."+n+".accountId")?20:-1),c(3),A(r.taxRates),c(2),u(r.validField("invoiceItems."+n+".taxRate")?25:-1)}}function Fe(a,t){a&1&&(i(0,"tr",33)(1,"td",56)(2,"small"),o(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),e()()())}var T=class a{platformId=s(M);fb=s(ie);destroyRef=s(O);accountService=s(L);commonAdminService=s(ae);clientService=s(B);formErrorService=s(re);customToastService=s(oe);accounts=g([]);economicActivities=g([]);formInvoiceService=s(ue);isFormSubmitting=S(()=>this.formInvoiceService.isFormSubmitting());taxRates=j;clients=g([]);newInvoiceForm=this.fb.group({client:[null,[m.required]],initDate:[this.currentDate,[m.required]],expireDate:[this.dateInSevenDay,[]],currency:["USD",[m.required]],reference:["",[]],receptorActivities:["",[]],invoiceItems:this.fb.array([this.createInvoiceItemFormGroup(),this.createInvoiceItemFormGroup()])});subtotal=S(()=>this.formInvoiceService.subtotal());totalDiscount=S(()=>this.formInvoiceService.totalDiscount());totalTax=S(()=>this.formInvoiceService.totalTax());totalAmount=S(()=>this.formInvoiceService.totalAmount());get isBrowser(){return q(this.platformId)}get currentDate(){return N(new Date)}get dateInSevenDay(){let t=new Date,n=new Date(new Date().setDate(t.getDate()+7));return N(n)}ngOnInit(){this.formInvoiceService.cleanTotalValues(),this.fetchAllShortClients(),this.fetchAccounts(),this.invoiceItems.controls.forEach(t=>{this.setupItemGroupValueChangeListener(t)}),this.newInvoiceForm.get("client")?.valueChanges.pipe(h(this.destroyRef)).subscribe(t=>{t?this.fetchEconomicActivities(t.id):(this.economicActivities.set([]),this.newInvoiceForm.controls.receptorActivities.patchValue(""))})}fetchEconomicActivities(t){this.clientService.findEconomicActivities(t).pipe(h(this.destroyRef)).subscribe(n=>{n&&n.length>0?this.economicActivities.set(n):(this.economicActivities.set([]),this.newInvoiceForm.controls.receptorActivities.patchValue(""))})}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(h(this.destroyRef)).subscribe(t=>{t&&t.accounts&&this.accounts.set(t.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(h(this.destroyRef)).subscribe(t=>{t&&this.clients.set(t)})}validField(t){let n=this.newInvoiceForm.get(t);return n?n.touched&&n.invalid:!1}onExpireDateChange(t){this.newInvoiceForm.controls.expireDate.patchValue(t)}get invoiceItems(){return this.newInvoiceForm.get("invoiceItems")}createInvoiceItemFormGroup(){let t=this.fb.group({itemId:[null,[m.required]],description:["",[]],quantity:[1,[m.required,m.min(1)]],price:["",[m.required]],discount:[0,[]],accountId:["",[m.required,m.minLength(1)]],taxRate:["08",[m.required,,m.minLength(1)]]});return this.setupItemGroupValueChangeListener(t),t}addInvoiceItem(){this.invoiceItems.push(this.createInvoiceItemFormGroup()),this.formInvoiceService.calculateTotals(this.invoiceItems)}removeInvoiceItem(t){this.invoiceItems.removeAt(t),this.formInvoiceService.calculateTotals(this.invoiceItems)}setupItemGroupValueChangeListener(t){t.valueChanges.pipe(h(this.destroyRef),D(n=>n.quantity!==null&&n.price!==null&&n.discount!==null)).subscribe(()=>{this.formInvoiceService.calculateTotals(this.invoiceItems)})}onItemSelectedInRow(t,n){let r=this.invoiceItems.at(n);r&&t&&(r.patchValue({description:t.description||"",price:t.salePrice??0,accountId:t.saleAccountId??""}),this.formInvoiceService.calculateTotals(this.invoiceItems))}onCustomSubmitBtnClicked(t){this.callToAction(t)}callToAction(t){if(this.formErrorService.throwFormErrors(this.newInvoiceForm),!this.formInvoiceService.verifyInvoiceItems(this.invoiceItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.newInvoiceForm.controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.newInvoiceForm.invalid)return;let n=this.newInvoiceForm.value;switch(n.createdAt=$(new Date),t){case"save":n.status="borrador",n.action="save",this.formInvoiceService.onSaveAction(n);break;case"mark_as_sent":n.status="enviada",n.action="mark_as_sent",this.formInvoiceService.onSaveAction(n);break;case"send":n.status="borrador",n.action="send",this.formInvoiceService.handleCreateOrEditInvoiceSendingEmailAsWell(n);break;default:break}}comeBackToList(){this.commonAdminService.comeBackToList("/list-invoices")}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=k({type:a,selectors:[["new-invoice"]],decls:115,vars:32,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["for","currency",1,"w_100"],["formControlName","currency"],["value","USD"],["for","activities",1,"w_100"],["bindLabel","label","bindValue","code","placeholder","--Seleccione--","formControlName","receptorActivities",3,"items","searchable","multiple"],[1,"d-flex","justify-content-between","align-items-end","mb-1"],["for","reference",1,"w_100"],[1,"fas","fa-tag"],["type","text","formControlName","reference"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","invoiceItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Guardar","secondaryText","Guardando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"]],template:function(n,r){n&1&&(i(0,"div",0),l(1,"breadcrumb",1),i(2,"div",2)(3,"div",3)(4,"h3",4),o(5,"Nueva factura"),e(),i(6,"h4",5),_("click",function(){return r.comeBackToList()}),l(7,"i",6),o(8," Regresar "),e()(),i(9,"form",7)(10,"div",8)(11,"div",9)(12,"label",10),o(13," Cliente "),i(14,"span",11),o(15,"*"),e()(),l(16,"ng-select",12),p(17,Se,2,0,"small",13),e(),i(18,"div",9)(19,"label",14),o(20," Fecha inicio "),i(21,"span",11),o(22,"*"),e()(),l(23,"input",15),p(24,he,2,0,"small",13),e(),i(25,"div",9)(26,"label",16),o(27," Fecha expira "),i(28,"span",17),o(29,"opcional"),e()(),i(30,"quick-date-picker",18),_("dateChanged",function(f){return r.onExpireDateChange(f)}),e()(),i(31,"div",9)(32,"label",19),o(33," Moneda "),i(34,"span",11),o(35,"*"),e()(),i(36,"select",20)(37,"option",21),o(38,"USD"),e()()(),i(39,"div",9)(40,"label",22),o(41," Actividades econ\xF3micas "),i(42,"span",11),o(43,"*"),e()(),l(44,"ng-select",23),e(),i(45,"div",9)(46,"div",24)(47,"label",25),o(48," Referencia "),i(49,"span",17),o(50,"opcional"),e()(),l(51,"i",26),e(),l(52,"input",27),e()(),i(53,"table",28)(54,"thead")(55,"tr")(56,"th",29)(57,"label"),o(58,"Item"),e()(),i(59,"th",29)(60,"label"),o(61,"Descripci\xF3n"),e()(),i(62,"th",30)(63,"label"),o(64," Cantidad "),e()(),i(65,"th",30)(66,"label"),o(67,"Precio"),e()(),i(68,"th",30)(69,"label"),o(70,"Descuento (%)"),e()(),i(71,"th",30)(72,"label"),o(73,"Cuenta"),e()(),i(74,"th",30)(75,"label"),o(76,"Impuesto"),e()(),l(77,"th",30),e()(),i(78,"tbody",31),p(79,we,29,7,"tr",32)(80,Fe,4,0,"tr",33),e()(),i(81,"button",34),_("click",function(){return r.addInvoiceItem()}),l(82,"i",35),o(83," Agregar fila "),e(),i(84,"div",36)(85,"div",37)(86,"ul",38)(87,"li",39)(88,"span"),o(89,"Subtotal"),e(),i(90,"span"),o(91),I(92,"number"),e()(),i(93,"li",39)(94,"span"),o(95,"Descuento total"),e(),i(96,"span",13),o(97),I(98,"number"),e()(),i(99,"li",39)(100,"span"),o(101,"Impuesto total"),e(),i(102,"span"),o(103),I(104,"number"),e()(),l(105,"div",40),i(106,"li",41)(107,"span")(108,"span"),o(109,"Total"),e()(),i(110,"strong"),o(111),I(112,"number"),e()()()()(),i(113,"div",42)(114,"submit-button",43),_("btnWasClicked",function(f){return r.onCustomSubmitBtnClicked(f)}),e()()()()()),n&2&&(c(),d("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado facturas")("secondaryLink","/list-invoices"),c(8),d("formGroup",r.newInvoiceForm),c(7),d("items",r.clients())("searchable",!0),c(),u(r.validField("clientId")?17:-1),c(7),u(r.validField("initDate")?24:-1),c(20),d("items",r.economicActivities())("searchable",!0)("multiple",!0),c(35),d("ngForOf",r.invoiceItems.controls),c(),u(r.invoiceItems.value.length?-1:80),c(11),x(b(92,20,r.subtotal(),"1.2-2")),c(6),E(" - ",b(98,23,r.totalDiscount(),"1.2-2")," "),c(6),x(b(104,26,r.totalTax(),"1.2-2")),c(8),E(" ",b(112,29,r.totalAmount(),"1.2-2")," "),c(3),d("isFormSubmitting",r.isFormSubmitting())("buttonAction",r.formInvoiceService.saveAction))},dependencies:[V,R,G,ce,se,ne,K,ee,te,U,Q,Z,W,z,H,Y,J,X,me,le,de,pe],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{T as default};
