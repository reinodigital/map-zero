import{a as _e}from"./chunk-NI3X6XUU.js";import{b as ue,c as ve,d as fe}from"./chunk-PAXFDZZJ.js";import{a as se}from"./chunk-DBZ6B75W.js";import{a as me}from"./chunk-4F6HHH7Z.js";import{a as de,b as pe}from"./chunk-ZTA6ATBK.js";import"./chunk-DZLN3OZ3.js";import{a as y}from"./chunk-KGOR65YN.js";import{a as le}from"./chunk-4C3OHNXD.js";import{a as ce}from"./chunk-APDWSLEU.js";import{a as ae}from"./chunk-QULINWIQ.js";import{b as W,c as d,d as Q,e as H,h as J,i as K,k as X,l as Y,m as Z,n as ee,o as te,p as ie,q as ne,t as oe,u as re}from"./chunk-3MY7L4GX.js";import{A as j,B as E,C as $,J as z,f as R,i as V,j as G,k as q,p as L,w as B,z as U}from"./chunk-7DHE3FAM.js";import{Ba as N,C as k,Ib as r,Jb as F,Kb as D,La as c,Rb as x,Tb as b,Va as P,_a as p,ba as s,eb as u,ec as g,ia as C,ja as S,jb as v,mb as T,na as M,nb as w,ob as n,pb as t,qb as l,ub as A,wa as I,yb as h,zb as _}from"./chunk-QAVPLLNK.js";var he=(a,e)=>e.id,Ce=(a,e)=>e.code;function Se(a,e){a&1&&(n(0,"small",14),r(1," cliente es requerido "),t())}function ge(a,e){a&1&&(n(0,"small",14),r(1," fecha inicio es requerida "),t())}function xe(a,e){a&1&&(n(0,"small",14),r(1," item es requerido "),t())}function be(a,e){a&1&&(n(0,"small",14),r(1," cantidad debe ser > 0 "),t())}function Ee(a,e){a&1&&(n(0,"small",14),r(1," precio incorrecto "),t())}function ye(a,e){if(a&1&&(n(0,"option",53),r(1),t()),a&2){let i=e.$implicit;u("value",i.id),c(),D(" ",`${i.code} - ${i.name}`," ")}}function Fe(a,e){a&1&&(n(0,"small",14),r(1," contabilidad es requerido "),t())}function De(a,e){if(a&1&&(n(0,"option",53),r(1),t()),a&2){let i=e.$implicit;u("value",i.code),c(),F(i.label)}}function Te(a,e){a&1&&(n(0,"small",14),r(1," impuesto es requerido "),t())}function we(a,e){if(a&1){let i=A();n(0,"tr",45)(1,"td")(2,"custom-select",46),h("itemSelectedEmitter",function(m){let f=C(i).index,Ie=_(2);return S(Ie.onItemSelectedInRow(m,f))}),t(),p(3,xe,2,0,"small",14),t(),n(4,"td"),l(5,"textarea",47),t(),n(6,"td"),l(7,"input",48),p(8,be,2,0,"small",14),t(),n(9,"td"),l(10,"input",49),p(11,Ee,2,0,"small",14),t(),n(12,"td"),l(13,"input",50),t(),n(14,"td")(15,"select",51)(16,"option",52),r(17,"--Seleccione--"),t(),T(18,ye,2,2,"option",53,he),t(),p(20,Fe,2,0,"small",14),t(),n(21,"td")(22,"select",54),T(23,De,2,2,"option",53,Ce),t(),p(25,Te,2,0,"small",14),t(),n(26,"td")(27,"button",55),h("click",function(){let m=C(i).index,f=_(2);return S(f.removeInvoiceItem(m))}),l(28,"i",56),t()()()}if(a&2){let i=e.index,o=_(2);u("formGroupName",i)("id","row_"+i),c(3),v(o.validField("invoiceItems."+i+".itemId")?3:-1),c(5),v(o.validField("invoiceItems."+i+".quantity")?8:-1),c(3),v(o.validField("invoiceItems."+i+".price")?11:-1),c(7),w(o.accounts()),c(2),v(o.validField("invoiceItems."+i+".accountId")?20:-1),c(3),w(o.taxRates),c(2),v(o.validField("invoiceItems."+i+".taxRate")?25:-1)}}function Ae(a,e){a&1&&(n(0,"tr",34)(1,"td",57)(2,"small"),r(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),t()()())}function Oe(a,e){if(a&1){let i=A();n(0,"form",7)(1,"div",9)(2,"div",10)(3,"label",11),r(4," Cliente "),n(5,"span",12),r(6,"*"),t()(),l(7,"ng-select",13),p(8,Se,2,0,"small",14),t(),n(9,"div",10)(10,"label",15),r(11," Fecha inicio "),n(12,"span",12),r(13,"*"),t()(),l(14,"input",16),p(15,ge,2,0,"small",14),t(),n(16,"div",10)(17,"label",17),r(18," Fecha expira "),n(19,"span",18),r(20,"opcional"),t()(),n(21,"quick-date-picker",19),h("dateChanged",function(m){C(i);let f=_();return S(f.onExpireDateChange(m))}),t()(),n(22,"div",10)(23,"label",17),r(24," Moneda "),n(25,"span",12),r(26,"*"),t()(),n(27,"select",20)(28,"option",21),r(29,"USD"),t()()(),n(30,"div",10)(31,"div",22)(32,"label",23),r(33," Referencia "),n(34,"span",18),r(35,"opcional"),t()(),l(36,"i",24),t(),l(37,"input",25),t(),n(38,"div",10)(39,"div",26)(40,"label",27),r(41," N\xFAmero cotizaci\xF3n "),t(),n(42,"span"),r(43,"#"),t()(),l(44,"input",28),t()(),n(45,"table",29)(46,"thead")(47,"tr")(48,"th",30)(49,"label"),r(50,"Item"),t()(),n(51,"th",30)(52,"label"),r(53,"Descripci\xF3n"),t()(),n(54,"th",31)(55,"label"),r(56," Cantidad "),t()(),n(57,"th",31)(58,"label"),r(59,"Precio"),t()(),n(60,"th",31)(61,"label"),r(62,"Descuento (%)"),t()(),n(63,"th",31)(64,"label"),r(65,"Cuenta"),t()(),n(66,"th",31)(67,"label"),r(68,"Impuesto"),t()(),l(69,"th",31),t()(),n(70,"tbody",32),p(71,we,29,7,"tr",33)(72,Ae,4,0,"tr",34),t()(),n(73,"button",35),h("click",function(){C(i);let m=_();return S(m.addInvoiceItem())}),l(74,"i",36),r(75," Agregar fila "),t(),n(76,"div",37)(77,"div",38)(78,"ul",39)(79,"li",40)(80,"span"),r(81,"Subtotal"),t(),n(82,"span"),r(83),x(84,"number"),t()(),n(85,"li",40)(86,"span"),r(87,"Descuento total"),t(),n(88,"span",14),r(89),x(90,"number"),t()(),n(91,"li",40)(92,"span"),r(93,"Impuesto total"),t(),n(94,"span"),r(95),x(96,"number"),t()(),l(97,"div",41),n(98,"li",42)(99,"span")(100,"span"),r(101,"Total"),t()(),n(102,"strong"),r(103),x(104,"number"),t()()()()(),n(105,"div",43)(106,"submit-button",44),h("btnWasClicked",function(m){C(i);let f=_();return S(f.onCustomSubmitBtnClicked(m))}),t()()()}if(a&2){let i,o=_();u("formGroup",o.editInvoiceForm()),c(7),u("items",o.clients())("searchable",!0),c(),v(o.validField("clientId")?8:-1),c(7),v(o.validField("initDate")?15:-1),c(29),u("value",(i=o.invoice())==null?null:i.invoiceNumber),c(27),u("ngForOf",o.invoiceItems.controls),c(),v(o.invoiceItems.value.length?-1:72),c(11),F(b(84,14,o.subtotal(),"1.2-2")),c(6),D(" - ",b(90,17,o.totalDiscount(),"1.2-2")," "),c(6),F(b(96,20,o.totalTax(),"1.2-2")),c(8),D(" ",b(104,23,o.totalAmount(),"1.2-2")," "),c(3),u("isFormSubmitting",o.isFormSubmitting())("buttonAction",o.formInvoiceService.editAction)}}function ke(a,e){if(a&1&&l(0,"tracking-entity",8),a&2){let i=_();u("tracking",i.invoice().tracking)("entity",i.entityData())}}var O=class a{platformId=s(N);fb=s(oe);destroyRef=s(M);activatedRoute=s(L);accountService=s(B);commonAdminService=s(le);invoiceService=s(z);clientService=s(U);formErrorService=s(ce);customToastService=s(ae);entityData=I(null);sellers=I([]);accounts=I([]);invoiceId=I(null);invoice=I(null);formInvoiceService=s(_e);isFormSubmitting=g(()=>this.formInvoiceService.isFormSubmitting());taxRates=$;clients=I([]);editInvoiceForm=I(null);subtotal=g(()=>this.formInvoiceService.subtotal());totalDiscount=g(()=>this.formInvoiceService.totalDiscount());totalTax=g(()=>this.formInvoiceService.totalTax());totalAmount=g(()=>this.formInvoiceService.totalAmount());get isBrowser(){return q(this.platformId)}get currentDate(){return E(new Date)}get dateInSevenDay(){let e=new Date,i=new Date(new Date().setDate(e.getDate()+7));return E(i)}constructor(){this.invoiceId.set(this.activatedRoute.snapshot.params.id),this.entityData.set({refEntity:"Quote",refEntityId:this.invoiceId()})}ngOnInit(){this.fetchAllShortClients(),this.fetchAccounts(),this.fetchInvoiceById()}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(y(this.destroyRef)).subscribe(e=>{e&&e.accounts&&this.accounts.set(e.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(y(this.destroyRef)).subscribe(e=>{e&&this.clients.set(e)})}fetchInvoiceById(){this.invoiceService.fetchOne(this.invoiceId()).pipe(y(this.destroyRef)).subscribe(e=>{e&&e.id&&(this.invoice.set(e),this.fillOutInvoiceForm())})}fillOutInvoiceForm(){let e=this.invoice(),i=this.fb.array(e.invoiceItems.map(o=>{let m={itemId:o.item.id,description:o.description??"",quantity:o.quantity,price:o.price,discount:o.discount??0,accountId:o.account?.id,taxRate:o.taxRate??"08",id:o.id},f=this.createInvoiceItemFormGroup();return f.patchValue(m),f}));this.editInvoiceForm.set(this.fb.group({client:[e.client,[d.required]],initDate:[E(new Date(e.initDate??new Date)),[d.required]],expireDate:[E(new Date(e.expireDate??new Date)),[]],currency:[e.currency??"USD",[d.required]],reference:[e.reference??"",[]],invoiceItems:i})),this.invoiceItems.controls.forEach(o=>{this.setupItemGroupValueChangeListener(o)}),this.invoiceItems&&this.invoiceItems.controls&&this.formInvoiceService.calculateTotals(this.invoiceItems)}validField(e){let i=this.editInvoiceForm()?.get(e);return i?i.touched&&i.invalid:!1}onExpireDateChange(e){this.editInvoiceForm()?.controls.expireDate.patchValue(e)}get invoiceItems(){return this.editInvoiceForm()?.get("invoiceItems")}createInvoiceItemFormGroup(){let e=this.fb.group({id:[null],itemId:[null,[d.required]],description:["",[]],quantity:[1,[d.required,d.min(1)]],price:["",[d.required]],discount:[0,[]],accountId:["",[d.required,d.minLength(1)]],taxRate:["08",[d.required,d.minLength(1)]]});return this.setupItemGroupValueChangeListener(e),e}addInvoiceItem(){this.invoiceItems.push(this.createInvoiceItemFormGroup()),this.formInvoiceService.calculateTotals(this.invoiceItems)}removeInvoiceItem(e){this.invoiceItems.removeAt(e),this.formInvoiceService.calculateTotals(this.invoiceItems)}setupItemGroupValueChangeListener(e){e.valueChanges.pipe(y(this.destroyRef),k(i=>i.quantity!==null&&i.price!==null&&i.discount!==null)).subscribe(()=>{let i=this.invoiceItems;i&&this.formInvoiceService.calculateTotals(i)})}onItemSelectedInRow(e,i){let o=this.invoiceItems.at(i);o&&e&&(o.patchValue({description:this.formInvoiceService.getCorrectDescriptionFromItemSelectedEmitter(this.invoice(),e),price:this.formInvoiceService.getCorrectPriceFromItemSelectedEmitter(this.invoice(),e),accountId:this.formInvoiceService.getCorrectAccountFromItemSelectedEmitter(this.invoice(),e)}),this.formInvoiceService.calculateTotals(this.invoiceItems))}onCustomSubmitBtnClicked(e){this.callToAction(e)}callToAction(e){if(this.formErrorService.throwFormErrors(this.editInvoiceForm()),!this.formInvoiceService.verifyInvoiceItems(this.invoiceItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.editInvoiceForm().controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.editInvoiceForm().invalid){this.formErrorService.throwFormErrors(this.editInvoiceForm());return}let i=this.editInvoiceForm().value;i.updatedAt=j(new Date),e==="edit"&&this.formInvoiceService.onEditAction(this.invoiceId(),i),e==="edit_and_send"&&(this.invoice()?.status==="borrador"&&(i.status="enviada"),this.formInvoiceService.handleCreateOrEditInvoiceSendingEmailAsWell(i,this.invoiceId()))}comeBackToList(){this.commonAdminService.comeBackToList("/list-invoices")}static \u0275fac=function(i){return new(i||a)};static \u0275cmp=P({type:a,selectors:[["edit-invoice"]],decls:11,vars:6,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[3,"tracking","entity"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],[1,"d-flex","justify-content-between","align-items-end","mb-1"],["for","reference",1,"w_100"],[1,"fas","fa-tag"],["type","text","formControlName","reference"],[1,"d-flex","justify-content-between","align-items-end"],["for","quoteNumber",1,"w_100"],["type","text","disabled","",3,"value"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","invoiceItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Editar","secondaryText","Editando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"]],template:function(i,o){i&1&&(n(0,"div",0),l(1,"breadcrumb",1),n(2,"div",2)(3,"div",3)(4,"h3",4),r(5,"Editar factura"),t(),n(6,"h4",5),h("click",function(){return o.comeBackToList()}),l(7,"i",6),r(8," Regresar "),t()(),p(9,Oe,107,26,"form",7),t()(),p(10,ke,1,2,"tracking-entity",8)),i&2&&(c(),u("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado facturas")("secondaryLink","/list-invoices"),c(8),v(o.editInvoiceForm()?9:-1),c(),v(o.invoice()?10:-1))},dependencies:[G,R,V,me,ue,re,J,ie,ne,W,K,te,Q,H,X,ee,Y,Z,pe,de,ve,fe,se],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{O as default};
