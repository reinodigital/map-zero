import{a as ve}from"./chunk-ABUNKPK5.js";import{b as de,c as pe,d as ue}from"./chunk-NXWWDWK6.js";import{a as ce}from"./chunk-OS3EXCMQ.js";import{a as me,b as se}from"./chunk-RZK5OI6K.js";import"./chunk-VC644A6X.js";import{a as x}from"./chunk-KGOR65YN.js";import{a as le}from"./chunk-NEVGVLEA.js";import{a as ae}from"./chunk-U4TVSC3Q.js";import{a as re}from"./chunk-QULINWIQ.js";import{b as W,c as m,d as z,e as K,h as Q,i as H,k as J,l as X,m as Y,n as Z,o as ee,p as te,q as ie,t as ne,u as oe}from"./chunk-SRQMAJVA.js";import{A as j,B as T,C as U,f as R,i as G,j as q,k as V,v as L,w as B,z as $}from"./chunk-7OFENO7U.js";import{Ba as M,C as A,Ib as o,Jb as b,Kb as h,La as l,Rb as I,Tb as g,Va as k,_a as d,ba as s,eb as p,ec as S,ia as E,ja as y,jb as u,mb as F,na as O,nb as N,ob as t,pb as e,qb as c,ub as P,wa as w,yb as _,zb as C}from"./chunk-QAVPLLNK.js";var _e=(r,i)=>i.id,Se=(r,i)=>i.code;function Ie(r,i){r&1&&(t(0,"small",13),o(1," cliente es requerido "),e())}function ge(r,i){r&1&&(t(0,"small",13),o(1," fecha inicio es requerida "),e())}function Ce(r,i){r&1&&(t(0,"small",13),o(1," item es requerido "),e())}function be(r,i){r&1&&(t(0,"small",13),o(1," cantidad debe ser > 0 "),e())}function he(r,i){r&1&&(t(0,"small",13),o(1," precio incorrecto "),e())}function xe(r,i){if(r&1&&(t(0,"option",50),o(1),e()),r&2){let n=i.$implicit;p("value",n.id),l(),h(" ",`${n.code} - ${n.name}`," ")}}function Ee(r,i){r&1&&(t(0,"small",13),o(1," contabilidad es requerido "),e())}function ye(r,i){if(r&1&&(t(0,"option",50),o(1),e()),r&2){let n=i.$implicit;p("value",n.code),l(),b(n.label)}}function we(r,i){r&1&&(t(0,"small",13),o(1," impuesto es requerido "),e())}function Fe(r,i){if(r&1){let n=P();t(0,"tr",42)(1,"td")(2,"custom-select",43),_("itemSelectedEmitter",function(v){let f=E(n).index,fe=C();return y(fe.onItemSelectedInRow(v,f))}),e(),d(3,Ce,2,0,"small",13),e(),t(4,"td"),c(5,"textarea",44),e(),t(6,"td"),c(7,"input",45),d(8,be,2,0,"small",13),e(),t(9,"td"),c(10,"input",46),d(11,he,2,0,"small",13),e(),t(12,"td"),c(13,"input",47),e(),t(14,"td")(15,"select",48)(16,"option",49),o(17,"--Seleccione--"),e(),F(18,xe,2,2,"option",50,_e),e(),d(20,Ee,2,0,"small",13),e(),t(21,"td")(22,"select",51),F(23,ye,2,2,"option",50,Se),e(),d(25,we,2,0,"small",13),e(),t(26,"td")(27,"button",52),_("click",function(){let v=E(n).index,f=C();return y(f.removeInvoiceItem(v))}),c(28,"i",53),e()()()}if(r&2){let n=i.index,a=C();p("formGroupName",n)("id","row_"+n),l(3),u(a.validField("invoiceItems."+n+".itemId")?3:-1),l(5),u(a.validField("invoiceItems."+n+".quantity")?8:-1),l(3),u(a.validField("invoiceItems."+n+".price")?11:-1),l(7),N(a.accounts()),l(2),u(a.validField("invoiceItems."+n+".accountId")?20:-1),l(3),N(a.taxRates),l(2),u(a.validField("invoiceItems."+n+".taxRate")?25:-1)}}function Ne(r,i){r&1&&(t(0,"tr",31)(1,"td",54)(2,"small"),o(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),e()()())}var D=class r{platformId=s(M);fb=s(ne);destroyRef=s(O);authService=s(L);accountService=s(B);commonAdminService=s(le);clientService=s($);formErrorService=s(ae);customToastService=s(re);accounts=w([]);formInvoiceService=s(ve);isFormSubmitting=S(()=>this.formInvoiceService.isFormSubmitting());taxRates=U;clients=w([]);newInvoiceForm=this.fb.group({client:[null,[m.required]],initDate:[this.currentDate,[m.required]],expireDate:[this.dateInSevenDay,[]],currency:["USD",[m.required]],reference:["",[]],invoiceItems:this.fb.array([this.createInvoiceItemFormGroup(),this.createInvoiceItemFormGroup()])});subtotal=S(()=>this.formInvoiceService.subtotal());totalDiscount=S(()=>this.formInvoiceService.totalDiscount());totalTax=S(()=>this.formInvoiceService.totalTax());totalAmount=S(()=>this.formInvoiceService.totalAmount());get isBrowser(){return V(this.platformId)}get currentDate(){return T(new Date)}get dateInSevenDay(){let i=new Date,n=new Date(new Date().setDate(i.getDate()+7));return T(n)}ngOnInit(){this.formInvoiceService.cleanTotalValues(),this.fetchAllShortClients(),this.fetchAccounts(),this.invoiceItems.controls.forEach(i=>{this.setupItemGroupValueChangeListener(i)})}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(x(this.destroyRef)).subscribe(i=>{i&&i.accounts&&this.accounts.set(i.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(x(this.destroyRef)).subscribe(i=>{i&&this.clients.set(i)})}validField(i){let n=this.newInvoiceForm.get(i);return n?n.touched&&n.invalid:!1}onExpireDateChange(i){this.newInvoiceForm.controls.expireDate.patchValue(i)}get invoiceItems(){return this.newInvoiceForm.get("invoiceItems")}createInvoiceItemFormGroup(){let i=this.fb.group({itemId:[null,[m.required]],description:["",[]],quantity:[1,[m.required,m.min(1)]],price:["",[m.required]],discount:[0,[]],accountId:["",[m.required,m.minLength(1)]],taxRate:["08",[m.required,,m.minLength(1)]]});return this.setupItemGroupValueChangeListener(i),i}addInvoiceItem(){this.invoiceItems.push(this.createInvoiceItemFormGroup()),this.formInvoiceService.calculateTotals(this.invoiceItems)}removeInvoiceItem(i){this.invoiceItems.removeAt(i),this.formInvoiceService.calculateTotals(this.invoiceItems)}setupItemGroupValueChangeListener(i){i.valueChanges.pipe(x(this.destroyRef),A(n=>n.quantity!==null&&n.price!==null&&n.discount!==null)).subscribe(()=>{this.formInvoiceService.calculateTotals(this.invoiceItems)})}onItemSelectedInRow(i,n){let a=this.invoiceItems.at(n);a&&i&&(a.patchValue({description:i.description||"",price:i.salePrice??0,accountId:i.saleAccountId??""}),this.formInvoiceService.calculateTotals(this.invoiceItems))}onCustomSubmitBtnClicked(i){this.callToAction(i)}callToAction(i){if(this.formErrorService.throwFormErrors(this.newInvoiceForm),!this.formInvoiceService.verifyInvoiceItems(this.invoiceItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.newInvoiceForm.controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.newInvoiceForm.invalid)return;let n=this.newInvoiceForm.value;switch(n.createdAt=j(new Date),i){case"save":n.status="borrador",n.action="save",this.formInvoiceService.onSaveAction(n);break;case"mark_as_sent":n.status="enviada",n.action="mark_as_sent",this.formInvoiceService.onSaveAction(n);break;case"send":n.status="borrador",n.action="send",this.formInvoiceService.handleCreateOrEditInvoiceSendingEmailAsWell(n);break;default:break}}comeBackToList(){this.commonAdminService.comeBackToList("/list-invoices")}static \u0275fac=function(n){return new(n||r)};static \u0275cmp=k({type:r,selectors:[["new-invoice"]],decls:109,vars:29,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["for","currency",1,"w_100"],["formControlName","currency"],["value","USD"],[1,"d-flex","justify-content-between","align-items-end","mb-1"],["for","reference",1,"w_100"],[1,"fas","fa-tag"],["type","text","formControlName","reference"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","invoiceItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Guardar","secondaryText","Guardando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"]],template:function(n,a){n&1&&(t(0,"div",0),c(1,"breadcrumb",1),t(2,"div",2)(3,"div",3)(4,"h3",4),o(5,"Nueva factura"),e(),t(6,"h4",5),_("click",function(){return a.comeBackToList()}),c(7,"i",6),o(8," Regresar "),e()(),t(9,"form",7)(10,"div",8)(11,"div",9)(12,"label",10),o(13," Cliente "),t(14,"span",11),o(15,"*"),e()(),c(16,"ng-select",12),d(17,Ie,2,0,"small",13),e(),t(18,"div",9)(19,"label",14),o(20," Fecha inicio "),t(21,"span",11),o(22,"*"),e()(),c(23,"input",15),d(24,ge,2,0,"small",13),e(),t(25,"div",9)(26,"label",16),o(27," Fecha expira "),t(28,"span",17),o(29,"opcional"),e()(),t(30,"quick-date-picker",18),_("dateChanged",function(f){return a.onExpireDateChange(f)}),e()(),t(31,"div",9)(32,"label",19),o(33," Moneda "),t(34,"span",11),o(35,"*"),e()(),t(36,"select",20)(37,"option",21),o(38,"USD"),e()()(),t(39,"div",9)(40,"div",22)(41,"label",23),o(42," Referencia "),t(43,"span",17),o(44,"opcional"),e()(),c(45,"i",24),e(),c(46,"input",25),e()(),t(47,"table",26)(48,"thead")(49,"tr")(50,"th",27)(51,"label"),o(52,"Item"),e()(),t(53,"th",27)(54,"label"),o(55,"Descripci\xF3n"),e()(),t(56,"th",28)(57,"label"),o(58," Cantidad "),e()(),t(59,"th",28)(60,"label"),o(61,"Precio"),e()(),t(62,"th",28)(63,"label"),o(64,"Descuento (%)"),e()(),t(65,"th",28)(66,"label"),o(67,"Cuenta"),e()(),t(68,"th",28)(69,"label"),o(70,"Impuesto"),e()(),c(71,"th",28),e()(),t(72,"tbody",29),d(73,Fe,29,7,"tr",30)(74,Ne,4,0,"tr",31),e()(),t(75,"button",32),_("click",function(){return a.addInvoiceItem()}),c(76,"i",33),o(77," Agregar fila "),e(),t(78,"div",34)(79,"div",35)(80,"ul",36)(81,"li",37)(82,"span"),o(83,"Subtotal"),e(),t(84,"span"),o(85),I(86,"number"),e()(),t(87,"li",37)(88,"span"),o(89,"Descuento total"),e(),t(90,"span",13),o(91),I(92,"number"),e()(),t(93,"li",37)(94,"span"),o(95,"Impuesto total"),e(),t(96,"span"),o(97),I(98,"number"),e()(),c(99,"div",38),t(100,"li",39)(101,"span")(102,"span"),o(103,"Total"),e()(),t(104,"strong"),o(105),I(106,"number"),e()()()()(),t(107,"div",40)(108,"submit-button",41),_("btnWasClicked",function(f){return a.onCustomSubmitBtnClicked(f)}),e()()()()()),n&2&&(l(),p("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado facturas")("secondaryLink","/list-invoices"),l(8),p("formGroup",a.newInvoiceForm),l(7),p("items",a.clients())("searchable",!0),l(),u(a.validField("clientId")?17:-1),l(7),u(a.validField("initDate")?24:-1),l(49),p("ngForOf",a.invoiceItems.controls),l(),u(a.invoiceItems.value.length?-1:74),l(11),b(g(86,17,a.subtotal(),"1.2-2")),l(6),h(" - ",g(92,20,a.totalDiscount(),"1.2-2")," "),l(6),b(g(98,23,a.totalTax(),"1.2-2")),l(8),h(" ",g(106,26,a.totalAmount(),"1.2-2")," "),l(3),p("isFormSubmitting",a.isFormSubmitting())("buttonAction",a.formInvoiceService.saveAction))},dependencies:[q,R,G,ce,de,oe,Q,te,ie,W,H,ee,z,K,J,Z,X,Y,se,me,pe,ue],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{D as default};
