import{a as _e}from"./chunk-ZDLV3RSM.js";import{a as ve}from"./chunk-XACSRI3N.js";import{b as ue,c as fe}from"./chunk-HXDGC66B.js";import{a as se,b as de}from"./chunk-ZQVIZBGI.js";import{a as pe}from"./chunk-KVBJ4PGU.js";import"./chunk-IBKVHNU3.js";import{a as C}from"./chunk-GZHOXXQG.js";import{a as me}from"./chunk-5LJDG4R3.js";import{a as le}from"./chunk-FUDPSQJN.js";import{a as ae}from"./chunk-5TLBDS6K.js";import{a as ce}from"./chunk-WKFQL3IM.js";import{b as z,c as p,d as Q,e as H,h as J,i as K,k as X,l as Y,m as Z,n as ee,o as te,p as ie,q as ne,t as oe,u as re}from"./chunk-UP3F5373.js";import{A as j,B as y,C as $,K as W,f as R,i as V,j as G,k as q,p as L,w as B,z as U}from"./chunk-4ZQGKSBB.js";import{$a as u,Ab as h,Ba as M,C as k,Jb as r,Kb as F,Lb as A,Ma as a,Sb as x,Ub as E,Wa as P,ba as s,fb as d,fc as g,ia as S,ja as b,kb as v,na as N,nb as D,ob as T,pb as n,qb as t,rb as l,vb as w,wa as _,zb as I}from"./chunk-F6XVVQNR.js";var Ie=(c,e)=>e.id,Ce=(c,e)=>e.code;function Se(c,e){c&1&&(n(0,"small",14),r(1," cliente es requerido "),t())}function be(c,e){c&1&&(n(0,"small",14),r(1," fecha inicio es requerida "),t())}function ge(c,e){c&1&&(n(0,"small",14),r(1," item es requerido "),t())}function xe(c,e){c&1&&(n(0,"small",14),r(1," cantidad debe ser > 0 "),t())}function Ee(c,e){c&1&&(n(0,"small",14),r(1," precio incorrecto "),t())}function ye(c,e){if(c&1&&(n(0,"option",55),r(1),t()),c&2){let i=e.$implicit;d("value",i.id),a(),A(" ",`${i.code} - ${i.name}`," ")}}function Fe(c,e){c&1&&(n(0,"small",14),r(1," contabilidad es requerido "),t())}function Ae(c,e){if(c&1&&(n(0,"option",55),r(1),t()),c&2){let i=e.$implicit;d("value",i.code),a(),F(i.label)}}function De(c,e){c&1&&(n(0,"small",14),r(1," impuesto es requerido "),t())}function Te(c,e){if(c&1){let i=w();n(0,"tr",47)(1,"td")(2,"custom-select",48),I("itemSelectedEmitter",function(m){let f=S(i).index,he=h(2);return b(he.onItemSelectedInRow(m,f))}),t(),u(3,ge,2,0,"small",14),t(),n(4,"td"),l(5,"textarea",49),t(),n(6,"td"),l(7,"input",50),u(8,xe,2,0,"small",14),t(),n(9,"td"),l(10,"input",51),u(11,Ee,2,0,"small",14),t(),n(12,"td"),l(13,"input",52),t(),n(14,"td")(15,"select",53)(16,"option",54),r(17,"--Seleccione--"),t(),D(18,ye,2,2,"option",55,Ie),t(),u(20,Fe,2,0,"small",14),t(),n(21,"td")(22,"select",56),D(23,Ae,2,2,"option",55,Ce),t(),u(25,De,2,0,"small",14),t(),n(26,"td")(27,"button",57),I("click",function(){let m=S(i).index,f=h(2);return b(f.removeInvoiceItem(m))}),l(28,"i",58),t()()()}if(c&2){let i=e.index,o=h(2);d("formGroupName",i)("id","row_"+i),a(3),v(o.validField("invoiceItems."+i+".itemId")?3:-1),a(5),v(o.validField("invoiceItems."+i+".quantity")?8:-1),a(3),v(o.validField("invoiceItems."+i+".price")?11:-1),a(7),T(o.accounts()),a(2),v(o.validField("invoiceItems."+i+".accountId")?20:-1),a(3),T(o.taxRates),a(2),v(o.validField("invoiceItems."+i+".taxRate")?25:-1)}}function we(c,e){c&1&&(n(0,"tr",36)(1,"td",59)(2,"small"),r(3,' No se ha a\xF1adido fila, presione "Agregar fila" para incluir algunos. '),t()()())}function Oe(c,e){if(c&1){let i=w();n(0,"form",7)(1,"div",9)(2,"div",10)(3,"label",11),r(4," Cliente "),n(5,"span",12),r(6,"*"),t()(),l(7,"ng-select",13),u(8,Se,2,0,"small",14),t(),n(9,"div",10)(10,"label",15),r(11," Fecha inicio "),n(12,"span",12),r(13,"*"),t()(),l(14,"input",16),u(15,be,2,0,"small",14),t(),n(16,"div",10)(17,"label",17),r(18," Fecha expira "),n(19,"span",18),r(20,"opcional"),t()(),n(21,"quick-date-picker",19),I("dateChanged",function(m){S(i);let f=h();return b(f.onExpireDateChange(m))}),t()(),n(22,"div",10)(23,"label",17),r(24," Moneda "),n(25,"span",12),r(26,"*"),t()(),n(27,"select",20)(28,"option",21),r(29,"USD"),t()()(),n(30,"div",10)(31,"label",22),r(32," Actividades econ\xF3micas "),n(33,"span",12),r(34,"*"),t()(),l(35,"ng-select",23),t(),n(36,"div",10)(37,"div",24)(38,"label",25),r(39," Referencia "),n(40,"span",18),r(41,"opcional"),t()(),l(42,"i",26),t(),l(43,"input",27),t(),n(44,"div",10)(45,"div",28)(46,"label",29),r(47," N\xFAmero factura "),t(),n(48,"span"),r(49,"#"),t()(),l(50,"input",30),t()(),n(51,"table",31)(52,"thead")(53,"tr")(54,"th",32)(55,"label"),r(56,"Item"),t()(),n(57,"th",32)(58,"label"),r(59,"Descripci\xF3n"),t()(),n(60,"th",33)(61,"label"),r(62," Cantidad "),t()(),n(63,"th",33)(64,"label"),r(65,"Precio"),t()(),n(66,"th",33)(67,"label"),r(68,"Descuento (%)"),t()(),n(69,"th",33)(70,"label"),r(71,"Cuenta"),t()(),n(72,"th",33)(73,"label"),r(74,"Impuesto"),t()(),l(75,"th",33),t()(),n(76,"tbody",34),u(77,Te,29,7,"tr",35)(78,we,4,0,"tr",36),t()(),n(79,"button",37),I("click",function(){S(i);let m=h();return b(m.addInvoiceItem())}),l(80,"i",38),r(81," Agregar fila "),t(),n(82,"div",39)(83,"div",40)(84,"ul",41)(85,"li",42)(86,"span"),r(87,"Subtotal"),t(),n(88,"span"),r(89),x(90,"number"),t()(),n(91,"li",42)(92,"span"),r(93,"Descuento total"),t(),n(94,"span",14),r(95),x(96,"number"),t()(),n(97,"li",42)(98,"span"),r(99,"Impuesto total"),t(),n(100,"span"),r(101),x(102,"number"),t()(),l(103,"div",43),n(104,"li",44)(105,"span")(106,"span"),r(107,"Total"),t()(),n(108,"strong"),r(109),x(110,"number"),t()()()()(),n(111,"div",45)(112,"submit-button",46),I("btnWasClicked",function(m){S(i);let f=h();return b(f.onCustomSubmitBtnClicked(m))}),t()()()}if(c&2){let i,o=h();d("formGroup",o.editInvoiceForm()),a(7),d("items",o.clients())("searchable",!0),a(),v(o.validField("clientId")?8:-1),a(7),v(o.validField("initDate")?15:-1),a(20),d("items",o.economicActivities())("searchable",!0)("multiple",!0),a(15),d("value",(i=o.invoice())==null?null:i.invoiceNumber),a(27),d("ngForOf",o.invoiceItems.controls),a(),v(o.invoiceItems.value.length?-1:78),a(11),F(E(90,17,o.subtotal(),"1.2-2")),a(6),A(" - ",E(96,20,o.totalDiscount(),"1.2-2")," "),a(6),F(E(102,23,o.totalTax(),"1.2-2")),a(8),A(" ",E(110,26,o.totalAmount(),"1.2-2")," "),a(3),d("isFormSubmitting",o.isFormSubmitting())("buttonAction",o.formInvoiceService.editAction)}}function ke(c,e){if(c&1&&l(0,"tracking-entity",8),c&2){let i=h();d("tracking",i.invoice().tracking)("entity",i.entityData())}}var O=class c{platformId=s(M);fb=s(oe);destroyRef=s(N);activatedRoute=s(L);accountService=s(B);commonAdminService=s(le);invoiceService=s(W);clientService=s(U);formErrorService=s(ae);customToastService=s(ce);entityData=_(null);sellers=_([]);accounts=_([]);economicActivities=_([]);invoiceId=_(null);invoice=_(null);formInvoiceService=s(_e);isFormSubmitting=g(()=>this.formInvoiceService.isFormSubmitting());taxRates=$;clients=_([]);editInvoiceForm=_(null);subtotal=g(()=>this.formInvoiceService.subtotal());totalDiscount=g(()=>this.formInvoiceService.totalDiscount());totalTax=g(()=>this.formInvoiceService.totalTax());totalAmount=g(()=>this.formInvoiceService.totalAmount());get isBrowser(){return q(this.platformId)}get currentDate(){return y(new Date)}get dateInSevenDay(){let e=new Date,i=new Date(new Date().setDate(e.getDate()+7));return y(i)}constructor(){this.invoiceId.set(this.activatedRoute.snapshot.params.id),this.entityData.set({refEntity:"Quote",refEntityId:this.invoiceId()})}ngOnInit(){this.fetchAllShortClients(),this.fetchAccounts(),this.fetchInvoiceById()}setUpListenerClientField(){this.editInvoiceForm()?.get("client")?.valueChanges.pipe(C(this.destroyRef)).subscribe(e=>{e?this.fetchEconomicActivities(e.id):(this.economicActivities.set([]),this.editInvoiceForm()?.controls.receptorActivities.patchValue(""))})}fetchEconomicActivities(e){this.clientService.findEconomicActivities(e).pipe(C(this.destroyRef)).subscribe(i=>{i&&i.length>0?this.economicActivities.set(i):(this.economicActivities.set([]),this.editInvoiceForm()?.controls.receptorActivities.patchValue(""))})}fetchAccounts(){this.accountService.fetchAll(999,0,{}).pipe(C(this.destroyRef)).subscribe(e=>{e&&e.accounts&&this.accounts.set(e.accounts)})}fetchAllShortClients(){this.clientService.fetchAllShortClients().pipe(C(this.destroyRef)).subscribe(e=>{e&&this.clients.set(e)})}fetchInvoiceById(){this.invoiceService.fetchOne(this.invoiceId()).pipe(C(this.destroyRef)).subscribe(e=>{e&&e.id&&(this.invoice.set(e),this.fillOutInvoiceForm())})}fillOutInvoiceForm(){let e=this.invoice();this.fetchEconomicActivities(e.client.id);let i=this.fb.array(e.invoiceItems.map(o=>{let m={itemId:o.item.id,description:o.description??"",quantity:o.quantity,price:o.price,discount:o.discount??0,accountId:o.account?.id,taxRate:o.taxRate??"08",id:o.id},f=this.createInvoiceItemFormGroup();return f.patchValue(m),f}));this.editInvoiceForm.set(this.fb.group({client:[e.client,[p.required]],initDate:[y(new Date(e.initDate??new Date)),[p.required]],expireDate:[y(new Date(e.expireDate??new Date)),[]],currency:[e.currency??"USD",[p.required]],receptorActivities:[e.receptorActivities,[]],reference:[e.reference??"",[]],invoiceItems:i})),this.invoiceItems.controls.forEach(o=>{this.setupItemGroupValueChangeListener(o)}),this.invoiceItems&&this.invoiceItems.controls&&this.formInvoiceService.calculateTotals(this.invoiceItems),this.setUpListenerClientField()}validField(e){let i=this.editInvoiceForm()?.get(e);return i?i.touched&&i.invalid:!1}onExpireDateChange(e){this.editInvoiceForm()?.controls.expireDate.patchValue(e)}get invoiceItems(){return this.editInvoiceForm()?.get("invoiceItems")}createInvoiceItemFormGroup(){let e=this.fb.group({id:[null],itemId:[null,[p.required]],description:["",[]],quantity:[1,[p.required,p.min(1)]],price:["",[p.required]],discount:[0,[]],accountId:["",[p.required,p.minLength(1)]],taxRate:["08",[p.required,p.minLength(1)]]});return this.setupItemGroupValueChangeListener(e),e}addInvoiceItem(){this.invoiceItems.push(this.createInvoiceItemFormGroup()),this.formInvoiceService.calculateTotals(this.invoiceItems)}removeInvoiceItem(e){this.invoiceItems.removeAt(e),this.formInvoiceService.calculateTotals(this.invoiceItems)}setupItemGroupValueChangeListener(e){e.valueChanges.pipe(C(this.destroyRef),k(i=>i.quantity!==null&&i.price!==null&&i.discount!==null)).subscribe(()=>{let i=this.invoiceItems;i&&this.formInvoiceService.calculateTotals(i)})}onItemSelectedInRow(e,i){let o=this.invoiceItems.at(i);o&&e&&(o.patchValue({description:this.formInvoiceService.getCorrectDescriptionFromItemSelectedEmitter(this.invoice(),e),price:this.formInvoiceService.getCorrectPriceFromItemSelectedEmitter(this.invoice(),e),accountId:this.formInvoiceService.getCorrectAccountFromItemSelectedEmitter(this.invoice(),e)}),this.formInvoiceService.calculateTotals(this.invoiceItems))}onCustomSubmitBtnClicked(e){this.callToAction(e)}callToAction(e){if(this.formErrorService.throwFormErrors(this.editInvoiceForm()),!this.formInvoiceService.verifyInvoiceItems(this.invoiceItems)){this.customToastService.add({message:"Uno o m\xE1s items tienen error.",type:"error",duration:6e3});return}if(!this.editInvoiceForm().controls.client.value){this.customToastService.add({message:"Seleccione un cliente para continuar.",type:"error",duration:6e3});return}if(this.editInvoiceForm().invalid){this.formErrorService.throwFormErrors(this.editInvoiceForm());return}let i=this.editInvoiceForm().value;i.updatedAt=j(new Date),e==="edit"&&this.formInvoiceService.onEditAction(this.invoiceId(),i),e==="edit_and_send"&&(this.invoice()?.status==="borrador"&&(i.status="enviada"),this.formInvoiceService.handleCreateOrEditInvoiceSendingEmailAsWell(i,this.invoiceId()))}comeBackToList(){this.commonAdminService.comeBackToList("/list-invoices")}static \u0275fac=function(i){return new(i||c)};static \u0275cmp=P({type:c,selectors:[["edit-invoice"]],decls:11,vars:6,consts:[[1,"main_content"],[3,"primaryText","primaryLink","secondaryText","secondaryLink"],[1,"box"],[1,"d-flex","justify-content-between"],[1,""],[1,"cp",3,"click"],[1,"fa-solid","fa-angles-left"],[1,"form",3,"formGroup"],[3,"tracking","entity"],[1,"row"],[1,"col-12","col-sm-6","col-lg-4","mb-3"],["for","defaultSeller"],[1,"asterisk"],["bindLabel","name","placeholder","--Seleccione--","formControlName","client",3,"items","searchable"],[1,"text-danger"],["for","initDate",1,"w_100"],["type","date","formControlName","initDate"],["for","expireDate",1,"w_100"],[1,"muted"],[3,"dateChanged"],["formControlName","currency"],["value","USD"],["for","activities",1,"w_100"],["bindLabel","label","bindValue","code","placeholder","--Seleccione--","formControlName","receptorActivities",3,"items","searchable","multiple"],[1,"d-flex","justify-content-between","align-items-end","mb-1"],["for","reference",1,"w_100"],[1,"fas","fa-tag"],["type","text","formControlName","reference"],[1,"d-flex","justify-content-between","align-items-end"],["for","quoteNumber",1,"w_100"],["type","text","disabled","",3,"value"],[1,"table","table-sm","mb-3","mt-5"],[1,"col-2"],[1,"col-1"],["formArrayName","invoiceItems"],[3,"formGroupName","id",4,"ngFor","ngForOf"],[1,"no-elements"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fa","fa-plus"],[1,"row","mt-4"],[1,"col-md-6","offset-md-6"],[1,"list-group","list-group-flush"],[1,"total_price","d-flex","justify-content-between"],[1,"line_divider"],[1,"total_price","d-flex","justify-content-between","mt-3"],[1,"d-flex","align-items-center","mt-4"],["primaryText","Editar","secondaryText","Editando",3,"btnWasClicked","isFormSubmitting","buttonAction"],[3,"formGroupName","id"],["formControlName","itemId",3,"itemSelectedEmitter"],["formControlName","description","rows","1"],["type","number","formControlName","quantity"],["type","number","formControlName","price"],["type","number","formControlName","discount","placeholder","%"],["formControlName","accountId"],["value",""],[3,"value"],["formControlName","taxRate"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"fa","fa-trash"],["colspan","4"]],template:function(i,o){i&1&&(n(0,"div",0),l(1,"breadcrumb",1),n(2,"div",2)(3,"div",3)(4,"h3",4),r(5,"Editar factura"),t(),n(6,"h4",5),I("click",function(){return o.comeBackToList()}),l(7,"i",6),r(8," Regresar "),t()(),u(9,Oe,113,29,"form",7),t()(),u(10,ke,1,2,"tracking-entity",8)),i&2&&(a(),d("primaryText","Vista de ventas")("primaryLink","/sales-overview")("secondaryText","Listado facturas")("secondaryLink","/list-invoices"),a(8),v(o.editInvoiceForm()?9:-1),a(),v(o.invoice()?10:-1))},dependencies:[G,R,V,me,ue,re,J,ie,ne,z,K,te,Q,H,X,ee,Y,Z,de,se,ve,fe,pe],styles:["table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:.5rem;text-align:left;border:1px solid #ddd}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]{display:block;width:100%;height:100%;padding:.5rem;margin:0;border:none;background-color:transparent;box-sizing:border-box;font-size:inherit}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-select-container[_ngcontent-%COMP%]{border:none!important;background-color:transparent!important;height:100%;display:flex;align-items:center}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-value-wrapper[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]   .ng-input[_ngcontent-%COMP%]{padding:.5rem 0}td[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]:focus, td[_ngcontent-%COMP%]   ng-select[_ngcontent-%COMP%]:focus-within{outline:none}.total_price[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:.4rem}"],changeDetection:0})};export{O as default};
